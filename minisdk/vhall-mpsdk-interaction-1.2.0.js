module.exports=function(e){var t={};function s(i){if(t[i])return t[i].exports;var a=t[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)s.d(i,a,function(t){return e[t]}.bind(null,a));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t),s.d(t,"default",(function(){return he}));class i{constructor(e){this.requestParams={room_id:e.roomId||"",app_id:e.appId,third_party_user_id:e.thirdPartyUserId,access_token:e.accessToken,channelId:e.channelId,package_check:"peter",client:"wechat_applet"},this.host="https://api.vhallyun.com/sdk",this.requestApi=this.requestApi.bind(this)}requestApi(e,t,s,i){wx.request({url:`${this.host}${e}`,data:{...t,...this.requestParams},method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},success:e=>{e.statusCode>=400?i({code:400,message:"调用接口失败"}):200!==e.data.code?i(e.data):s(e.data)},fail:i})}}const a="/v2/inav/get-inav-info",r="/v2/inav/inav-user-list",o="/v2/inav/publish-inav-another",n="/v2/inav/audit-inav-publish",h="/v2/inav/apply-inav-publish",l="/v2/inav/askfor-inav-publish",c="/v2/inav/user-publish-callback",d="/v2/inav/kick-inav",u="/v2/inav/leave-room-force-inav",m="/v2/inav/get-kick-inav-list";class g{constructor(){this.dispatcher={eventListeners:{}}}on(e,t){void 0===this.dispatcher.eventListeners[e]&&(this.dispatcher.eventListeners[e]=[]),this.dispatcher.eventListeners[e].push(t)}off(e,t){if(!this.dispatcher.eventListeners[e])return;const s=this.dispatcher.eventListeners[e].indexOf(t);-1!==s&&this.dispatcher.eventListeners[e].splice(s,1)}emit(e,t={}){if(!e)throw new Error("Undefined event");const s=this.dispatcher.eventListeners[e]||[];for(let e=0;e<s.length;e+=1)s[e](t)}}const _="1.2.0",p="20200624",v={BROADCASTMUTESTREAM:"broadcastMuteStream",ONADDSTREAM:"onAddStream",ONREMOVESTREAM:"onRemoveStream",VRTCCONNECTREFUSED:"vrtc_connect_refused",VRTCCONNECTAGREE:"vrtc_connect_agree"},I=182001,E=182002,b=182003,R=182004,T=182006,S=182007,P=182014,M=182015,O=182021,A=182023,C=182024,f=182026,N=182027,y=182028,L=182029,k=182201,B=182202,V=182203,D=182204,U=182205,w=182206,F=182601,x=184001,Y=184003,z=184004,j=184008,q=184005,G=184007,H=184010,$=184012,W=184013,K=184201,J=184202,X=184203;class Q extends g{constructor(e){super(),this.vhallBase=e.vhallBase}connect(e,t,s,i,a=(()=>{}),r=(()=>{})){this.vhallBase.connectRtcIo({host:e.token.host}),this.vhallBase.on("onTaskError",e=>{this.checkName(e.socketName)&&(r(),this.emit("onError",{}))}),this.vhallBase.on("onOpen",o=>{if(!this.checkName(o.socketName))return;const n={token:e,version:t,pf:s,attributes:i};setTimeout(()=>{this.sendMessage("token",n).then(e=>{a(e.msg)}).catch(r)},1e3)}),this.vhallBase.on("onClose",e=>{this.checkName(e.socketName)&&this.emit("onClose",e)}),this.vhallBase.on("reConnecting",e=>{this.checkName(e.socketName)&&this.emit("reConnecting",{})}),this.vhallBase.on("reConnectFail",e=>{this.checkName(e.socketName)&&this.emit("reConnectFail",{})}),this.vhallBase.on("onError",e=>{this.checkName(e.socketName)&&this.emit("onError",{})}),this.vhallBase.on("allSocket",e=>{});const o=this.vhallBase.collect.get(this.vhallBase.socketName.RTC);o.on(v.ONADDSTREAM,e=>{this.emit(v.ONADDSTREAM,e)}),o.on(v.ONREMOVESTREAM,e=>{this.emit(v.ONREMOVESTREAM,e)}),o.on(v.BROADCASTMUTESTREAM,e=>{this.emit(v.BROADCASTMUTESTREAM,e)})}close(){try{this.vhallBase.close()}catch(e){}}initiativeReconnect(){this.vhallBase.initiativeReconnect()}sendMessage(e,t){return new Promise((s,i)=>{this.vhallBase.sendMessage(e,t).then(e=>{s(e)}).catch(e=>{i(e)})})}checkName(e){return e==this.vhallBase.socketName.RTC}}class Z{constructor(e){for(const t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}getId(){return this.streamId||""}getUser(){return this.user||{}}getUserId(){return this.user.id||""}}class ee{constructor(){this.END_OF_INPUT=-1,this.base64Chars=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],this.base64Str=null,this.base64Count=null,this.reverseBase64Chars=[];for(let e=0;e<this.base64Chars.length;e++)this.reverseBase64Chars[this.base64Chars[e]]=e}setBase64Str(e){this.base64Str=e,this.base64Count=0}readBase64(){if(!this.base64Str)return this.END_OF_INPUT;if(this.base64Count>=this.base64Str.length)return this.END_OF_INPUT;const e=255&this.base64Str.charCodeAt(this.base64Count);return this.base64Count+=1,e}readReverseBase64(){if(!this.base64Str)return this.END_OF_INPUT;for(;;){if(this.base64Count>=this.base64Str.length)return this.END_OF_INPUT;const e=this.base64Str.charAt(this.base64Count);if(this.base64Count+=1,this.reverseBase64Chars[e])return this.reverseBase64Chars[e];if("A"===e)return 0}}ntos(e){let t=e.toString(16);return 1===t.length&&(t=`0${t}`),t=`%${t}`,unescape(t)}encodeBase64(e){let t,s,i="";this.setBase64Str(e);const a=new Array(3);for(t=0,s=!1;!s&&(a[0]=this.readBase64())!==this.END_OF_INPUT;)a[1]=this.readBase64(),a[2]=this.readBase64(),i+=this.base64Chars[a[0]>>2],a[1]!==this.END_OF_INPUT?(i+=this.base64Chars[a[0]<<4&48|a[1]>>4],a[2]!==this.END_OF_INPUT?(i+=this.base64Chars[a[1]<<2&60|a[2]>>6],i+=this.base64Chars[63&a[2]]):(i+=this.base64Chars[a[1]<<2&60],i=`${i}=`,s=!0)):(i+=this.base64Chars[a[0]<<4&48],i=`${i}=`,i=`${i}=`,s=!0),t+=4,t>=76&&(i=`${i}\n`,t=0);return i}decodeBase64(e){let t,s="";this.setBase64Str(e);const i=new Array(4);for(t=!1;!t&&(i[0]=this.readReverseBase64())!==this.END_OF_INPUT&&(i[1]=this.readReverseBase64())!==this.END_OF_INPUT;)i[2]=this.readReverseBase64(),i[3]=this.readReverseBase64(),s+=this.ntos(i[0]<<2&255|i[1]>>4),i[2]!==this.END_OF_INPUT?(s+=this.ntos(i[1]<<4&255|i[2]>>2),i[3]!==this.END_OF_INPUT?s+=this.ntos(i[2]<<6&255|i[3]):t=!0):t=!0;return s}}class te{constructor(){this.sessionId=te.random(),this.message="",this.monitor_api="/monitor",this.reportMessage={livePusher:{},livePlayer:{}},this.interval=null,this.biz_des02=2,this.pf="9",this.ver=_,this.date=p,this.browerUA="miniprogram";const{brand:e,model:t,version:s,system:i,platform:a,SDKVersion:r}=wx.getSystemInfoSync();this.min_system={brand:e,model:t,version:s,system:i,platform:a,SDKVersion:r},this.base64=new ee,this.publishMessageLog=this.publishMessageLog.bind(this),this.playMessageLog=this.playMessageLog.bind(this),this.init=this.init.bind(this),this.upLogClose=this.upLogClose.bind(this),this.generalLog=this.generalLog.bind(this),this.generalAddStream=this.generalAddStream.bind(this),this.generalMessage=this.generalMessage.bind(this),this.connectSignallingLog=this.connectSignallingLog.bind(this),this.generalPush=this.generalPush.bind(this),this.reportVersion=this.reportVersion.bind(this),this.connectSignallingFailureLog=this.connectSignallingFailureLog.bind(this),this.sendPublish=this.sendPublish.bind(this),this.publishSuccess=this.publishSuccess.bind(this),this.sendSubscribe=this.sendSubscribe.bind(this),this.subscribeSuccess=this.subscribeSuccess.bind(this),this.upLogAddStream=this.upLogAddStream.bind(this),this.sendUnPublish=this.sendUnPublish.bind(this),this.unPublishSuccess=this.unPublishSuccess.bind(this),this.sendUnSubscribe=this.unSubscribeSuccess.bind(this),this.serverRemoveStream=this.serverRemoveStream.bind(this),this.upLogConfigRoomBroadCast=this.upLogConfigRoomBroadCast.bind(this),this.pushConfiguration=this.pushConfiguration.bind(this),this.pusherConnectionFail=this.pusherConnectionFail.bind(this),this.generalChangeReportMsg=this.generalChangeReportMsg.bind(this),this.playerConnectionFail=this.playerConnectionFail.bind(this),this.serverRemoveLocalStream=this.serverRemoveLocalStream.bind(this)}init(e){this.url=e.url?e.url:"https://t-dc.e.vhall.com/login",this.biz_role=e.biz_role,this.biz_id=e.biz_id,this.biz_des01=e.biz_des01,this.bu=e.bu,this.uid=e.uid,this.aid=e.aid,this.app_id=e.app_id,this.sd=e.sd;let t=this.url.split("/").length>=3?this.url.split("/")[2]:"t-dc.e.vhall.com";this.monitor_url=`https://${t}${this.monitor_api}`}static random(){const e=[1,2,3,4,5,6,7,8,9];return(new Date).valueOf()+String(e[Math.floor(Math.random()*e.length)])+String(e[Math.floor(Math.random()*e.length)])+String(e[Math.floor(Math.random()*e.length)])}push(e){wx.request({url:e,fail:e=>{console.error(`uplog failed!! ${e}`)}})}json2base64(e){return this.base64.encodeBase64(JSON.stringify(e).replace(/\s+/g,"")).replace(/\s+/g,"")}generalMessage(e={streamId:0}){return{s:this.sessionId,uid:this.uid,aid:this.aid,app_id:this.app_id,sd:this.sd,p:e&&e.streamId?e.streamId:0,pf:this.pf,ver:this.ver,bu:this.bu,min_system:this.min_system}}generalPush(e,t){const s=te.random(),i=this.json2base64(t),a=`${this.url}?k=${e}&id=${s}&s=${this.sessionId}&bu=${this.bu}&token=${i}`;this.push(a)}startInterval(){this.interval||(this.interval=setInterval(this.generalLog,3e4))}generalLog(e=!1){if(this.reportMessage.livePusher.reportAllowed){e&&this.generalChangeReportMsg({name:"livePusher",attr:"needCalculation",value:!0});try{this.publishMessageLog(this.reportMessage.livePusher)}catch(e){console.warn(e)}this.generalChangeReportMsg({name:"livePusher",attr:"lastTime",value:Date.now()}),this.generalChangeReportMsg({name:"livePusher",attr:"needCalculation",value:!1})}for(const t in this.reportMessage.livePlayer)if(this.reportMessage.livePlayer.hasOwnProperty(t)){let s=this.reportMessage.livePlayer[t];if(s.reportAllowed){e&&(s.needCalculation=!0);try{this.playMessageLog(s)}catch(e){console.warn(e)}s.lastTime=Date.now(),s.needCalculation=!1}}}generalAddStream(e,t="livePlayer"){"livePlayer"==t?this.reportMessage[t][e.streamId]={...e,needCalculation:!0,lastTime:Date.now(),reportAllowed:!0}:this.reportMessage[t]={...e,needCalculation:!0,lastTime:Date.now(),reportAllowed:!0},this.startInterval()}generalStopMessageLog(e,t="livePlayer",s=!1){if(s){try{this.publishMessageLog(this.reportMessage.livePusher)}catch(e){console.warn(e)}this.reportMessage.livePusher={}}if("livePlayer"==t){try{this.generalChangeReportMsg({name:"livePlayer",key:e.streamId,attr:"needCalculation",value:!0}),this.playMessageLog(this.reportMessage.livePlayer[e.streamId])}catch(e){console.warn(e)}delete this.reportMessage[t][e.streamId]}else{try{this.generalChangeReportMsg({name:"livePusher",attr:"needCalculation",value:!0}),this.publishMessageLog(this.reportMessage.livePusher)}catch(e){console.warn(e)}this.reportMessage.livePusher={}}Object.keys(this.reportMessage.livePlayer).length||Object.keys(this.reportMessage.livePusher).length||(clearInterval(this.interval),this.interval=null)}upLogClose(){this.generalLog(!0),clearInterval(this.interval),this.interval=null}pushConfiguration(e,t){let s=this.generalMessage(t);s={...s,currentBitrateKbps:this.reportMessage.livePusher.info?this.reportMessage.livePusher.info.videoFPS:0,videoWidth:this.reportMessage.livePusher.info?this.reportMessage.livePusher.info.videoWidth:0,videoHeight:this.reportMessage.livePusher.info?this.reportMessage.livePusher.videoHeight:0,streamType:this.reportMessage.livePusher.streamType||2,videoCodecPreference:"H264"},this.generalPush(e,s)}generalChangeReportMsg({name:e,key:t,attr:s,value:i}){"livePusher"==e?this.reportMessage[e][s]=i:this.reportMessage[e][t][s]=i}sendPublish(){const e=this.generalMessage(),t=T;this.generalPush(t,e)}publishSuccess(e){const t=this.generalMessage(e),s=S;this.generalPush(s,t)}sendSubscribe(e){const t=this.generalMessage(e),s=P;this.generalPush(s,t)}subscribeSuccess(e){const t=this.generalMessage(e),s=M;this.generalPush(s,t)}upLogAddStream(e){const t=this.generalMessage(e),s=O;this.generalPush(s,t)}sendUnPublish(e){const t=this.generalMessage(e),s=A;this.generalPush(s,t)}unPublishSuccess(e){const t=this.generalMessage(e),s=C;this.generalPush(s,t)}sendUnSubscribe(e){const t=this.generalMessage(e),s=f;this.generalPush(s,t)}unSubscribeSuccess(e){const t=this.generalMessage(e),s=L;this.generalPush(s,t)}serverRemoveStream(e){const t=this.generalMessage(e),s=y;this.generalPush(s,t)}connectSignallingLog(){const e=I,t=this.generalMessage({streamId:0});this.generalPush(e,t)}upLogConfigRoomBroadCast(e){const t=k;this.pushConfiguration(t,e)}ConfigRoomBroadCastSucc(e){const t=B;this.pushConfiguration(t,e)}upLogSetMixLayoutMode(e){const t=V;this.pushConfiguration(t,e)}setMixLayoutModeSucc(e){const t=D;this.pushConfiguration(t,e)}upLogSetMixLayoutMainScreen(e){const t=U;this.pushConfiguration(t,e)}setMixLayoutMainScreenSucc(e){const t=w;this.pushConfiguration(t,e)}closeSignallingLog(){const e=E,t=this.generalMessage();this.generalPush(e,t)}playMessageLog(e){const t=b;let s=this.generalMessage(e);s={...s,tt:3e4,errorcode:2002,vtype:e.streamType,videoWidth:e.info.videoWidth,videoHeight:e.info.videoHeight,bitrate:parseInt(e.info.videoBitrate+e.info.audioBitrate),tf:30*(e.info.videoBitrate+e.info.audioBitrate)*1024/8,uf:0,biz_role:this.biz_role,biz_id:this.biz_id,biz_des01:this.biz_des01,biz_des02:this.biz_des02,os:!1},e.needCalculation&&(s.tt=Math.abs(Date.now()-e.lastTime)),s.tt,this.generalPush(t,s)}publishMessageLog(e){const t=R;let s=this.generalMessage(e);s={...s,tt:3e4,errorcode:2003,vtype:e.streamType,videoWidth:e.info.videoWidth,videoHeight:e.info.videoHeight,bitrate:parseInt(e.info.videoBitrate+e.info.audioBitrate),tf:0,uf:30*(e.info.videoBitrate+e.info.audioBitrate)*1024/8,biz_role:this.biz_role,biz_id:this.biz_id,biz_des01:this.biz_des01,biz_des02:this.biz_des02,os:!1},e.needCalculation&&(s.tt=Math.abs(Date.now()-e.lastTime)),s.tt,this.generalPush(t,s)}reportVersion(){const e=F;let t=this.generalMessage();t={release_date:this.date,ua:this.browerUA,...t},this.generalPush(e,t)}connectSignallingFailureLog(){const e=x,t=this.generalMessage();this.generalPush(e,t)}publishError(){const e=Y,t=this.generalMessage();this.generalPush(e,t)}serverRemoveLocalStream(e){const t=q,s=this.generalMessage(e);this.generalPush(t,s)}subscribeFail(e){const t=G,s=this.generalMessage(e);this.generalPush(t,s)}unPublishFail(e){const t=H,s=this.generalMessage(e);this.generalPush(t,s)}unSubscribeFail(e){const t=$,s=this.generalMessage(e);this.generalPush(t,s)}serverOffLine(e){const t=W;let s=this.generalMessage();s={...s,...e},this.generalPush(t,s)}configRoomBroadCastFail(e){const t=K,s=this.generalMessage(e);this.generalPush(t,s)}setMixLayoutModeFail(e){const t=J,s=this.generalMessage(e);this.generalPush(t,s)}setMixLayoutMainScreenFail(e){const t=X,s=this.generalMessage(e);this.generalPush(t,s)}pusherConnectionFail(e){const t=z;let s=this.generalMessage(this.reportMessage.livePusher);s={...s,...e},this.generalPush(t,s)}playerConnectionFail(e){const t=j;let s=this.generalMessage(this.reportMessage.livePusher);s={...s,...e},this.generalPush(t,s)}closeSocketRtc(){const e=N,t=this.generalMessage(this.reportMessage.livePusher);this.generalPush(e,t)}signalingMessageSucc(){}signalingMessageFail(){}}function se(e,t){for(let s of Reflect.ownKeys(t))if("constructor"!==s&&"prototype"!==s&&"name"!==s){let i=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,i)}}class ie extends(function(...e){class t{constructor(){for(let t of e)se(this,new t)}}for(let s of e)se(t,s),se(t.prototype,s.prototype);return t}(g,te)){constructor(e){super(),this.socketRtc=new Q(e),this.spec=e,this.localStream=null,this.localuser=null,this.remoteStreams={},this.roomId="",this.isPublished=!1,this.rtmpUrl=null,this.vhallBase=e.vhallBase,this.deviceStatus={video:!0,audio:!0},this.base64=new ee,this.publish=this.publish.bind(this),this.configRoomBroadCast=this.configRoomBroadCast.bind(this),this.setMixLayoutMode=this.setMixLayoutMode.bind(this),this.setMixLayoutMainScreen=this.setMixLayoutMainScreen.bind(this),this.generatePLIPacket=this.generatePLIPacket.bind(this),this.unpublish=this.unpublish.bind(this),this.roomClose=this.roomClose.bind(this),this.initOnSocket()}initOnSocket(){this.socketRtc.on(v.ONADDSTREAM,e=>{this.socketOnAddStream(e)}),this.socketRtc.on(v.ONREMOVESTREAM,e=>{this.socketOnRemoveStream(e)}),this.socketRtc.on(v.BROADCASTMUTESTREAM,e=>{this.socketOnBroadcastMuteStream(e)}),this.socketRtc.on("onClose",e=>{this.socketRtcOnClose(e)}),this.socketRtc.on("reConnecting",()=>{this.socketOnReConnecting()}),this.socketRtc.on("reConnected",()=>{this.socketOnReConnected()}),this.socketRtc.on("reConnectFail",()=>{this.socketOnReConnectFail()}),this.socketRtc.on("onError",e=>{this.socketOnError(e)})}socketRtcOnClose(e){1e3!=e.code&&1001!=e.code&&1006!=e.code&&1005!=e.code&&this.serverOffLine(e),this.emit("onClose",e)}socketOnReConnecting(){this.emit("reConnecting")}socketOnReConnected(e){this.emit("reConnected",e)}socketOnReConnectFail(){this.emit("reConnectFail")}socketOnError(e){this.emit("onError",e)}socketOnAddStream(e){if(this.localStream&&e.id==this.localStream.streamId)return void this.emit("streamPublished",{stream:this.localStream});const t=new Z({state:e.state,sdp:e.sdp,streamId:e.id,local:!1,audio:e.audio,video:e.video,data:e.data,screen:e.screen,attributes:e.attributes,user:e.user,streamType:e.streamType,muteStream:e.muteStream});this.remoteStreams[e.id]=t,e.streamId=e.id,this.emit("streamAdd",t)}socketOnRemoveStream(e){if(this.localStream&&this.localStream.streamId==e.id)return void this.onStreamFailed(this.localStream);let t=this.remoteStreams[e.id];t&&(delete this.remoteStreams[e.id],this.emit("streamRemoved",{stream:t,msg:"Server Remove remote stream"}),e.streamId=e.id,this.serverRemoveStream(e))}socketOnBroadcastMuteStream({id:e,config:{muteStream:{video:t,audio:s}}}){this.localStream&&this.localStream.streamId==e||this.emit(v.BROADCASTMUTESTREAM,{streamId:e,enableCamera:!t,enableMic:!s})}onStreamFailed(e){this.serverRemoveLocalStream(e),this.emit("streamFailed",{msg:"Server Remove local stream",stream:e}),e.local?this.unpublish():this.unsubscribe(e)}connect(e,t=(()=>{}),s=(()=>{})){const i=this.base64.decodeBase64(this.spec.token);this.socketRtc.connect(JSON.parse(i),_,9,e.attributes,e=>{const s=[],a=e.streams||[];this.roomId=e.id,this.spec.defaultVideoBW=e.defaultVideoBW,this.spec.maxVideoBW=e.maxVideoBW,this.localuser=e.user;const r=Object.keys(a);for(let e=0;e<r.length;e++){const t=a[r[e]];let i=new Z({state:"rtmp",streamId:t.id,local:!1,audio:t.audio,video:t.video,data:t.data,screen:t.screen,attributes:t.attributes,user:t.user,streamType:t.streamType,muteStream:t.muteStream});s.push(i),this.remoteStreams[t.id]=i}const o={uid:this.localuser.id,aid:this.roomId,url:this.spec.upLogUrl,biz_role:this.spec.biz_role,biz_id:this.spec.biz_id,biz_des01:this.spec.biz_des01,bu:this.spec.bu,vid:this.spec.vid,app_id:this.spec.app_id?this.spec.app_id:0,sd:JSON.parse(i).token.host};this.init(o),this.connectSignallingLog(),this.reportVersion(),t({streams:s})},e=>{this.connectSignallingFailureLog(),s(e)})}roomClose(){this.unpublish(),this.socketRtc.close(),this.upLogClose()}publish(e=(()=>{}),t=(()=>{})){if(this.isPublished&&this.localStream)return void t("already pulished");this.isPublished=!0;const s={state:"rtmp",video:!0,audio:!0,data:!0,screen:!0,attributes:"",createOffer:!1,muteStream:{audio:!this.deviceStatus.audio,video:!this.deviceStatus.video},minVideoBW:this.spec.defaultVideoBW,streamType:2};this.sendPublish(),this.socketRtc.sendMessage("publish",s).then(t=>{this.localStream=new Z({state:"rtmp",local:!0,video:!0,audio:!0,data:!0,screen:!1,attributes:"",user:this.localuser,streamType:2,streamId:t.msg.streamId,sdp:t.msg.sdp}),e({url:t.msg.sdp,streamId:t.msg.streamId}),this.publishSuccess(this.localStream)}).catch(e=>{t(e),this.isPublished=!1,this.localStream=null,this.publishError()})}unpublish(e=(()=>{}),t=(()=>{})){if(this.isPublished=!1,!this.localStream)return void t("stream not found");let s={streamId:this.localStream.streamId};this.generalStopMessageLog(this.localStream,"livePusher"),this.sendUnPublish(this.localStream),this.socketRtc.sendMessage("unpublish",s).then(t=>{e(t),this.unPublishSuccess(s)}).catch(e=>{t(e),this.unPublishFail(s)}),this.localStream=null}subscribe(e,t=(()=>{}),s=(()=>{})){const i={state:"rtmp",sdp:e.sdp,streamId:e.streamId,data:!0,audio:!0,video:!0,createOffer:!1,muteStream:e.muteStream};this.sendSubscribe(i),this.socketRtc.sendMessage("subscribe",i).then(s=>{this.subscribeSuccess(i),t({streamId:e.streamId,url:s.msg.sdp,enableCamera:!e.muteStream.video,enableMic:!e.muteStream.audio})}).catch(e=>{s(e),this.subscribeFail(i)})}generatePLIPacket(e){this.socketRtc.sendMessage("generatePLIPacket",{streamId:e})}unsubscribe(e,t=(()=>{}),s=(()=>{})){const i={state:"rtmp",streamId:e.streamId};this.sendUnSubscribe(i),this.generalStopMessageLog(e),this.socketRtc.sendMessage("unsubscribe",i).then(()=>{this.unPublishSuccess(i),t()}).catch(e=>{s(e),this.unSubscribeFail(i)})}configRoomBroadCast(e,t=(()=>{}),s=(()=>{})){this.upLogConfigRoomBroadCast(this.localStream),this.socketRtc.sendMessage("ConfigRoomBroadCast",{config:JSON.stringify(e)}).then(()=>{t(),this.ConfigRoomBroadCastSucc(this.localStream)}).catch(()=>{s(),this.configRoomBroadCastFail(this.localStream)})}setMixLayoutMode(e,t=(()=>{}),s=(()=>{})){this.upLogSetMixLayoutMode(this.localStream),this.socketRtc.sendMessage("SetMixLayoutMode",{roomID:this.roomId,config:e}).then(()=>{t(),this.setMixLayoutModeSucc(this.localStream)}).catch(()=>{s(),this.setMixLayoutModeFail(this.localStream)})}setMixLayoutMainScreen(e,t=(()=>{}),s=(()=>{})){this.upLogSetMixLayoutMainScreen(this.localStream),this.socketRtc.sendMessage("SetMixLayoutMainScreen",{roomID:this.roomId,config:e}).then(()=>{t(),this.setMixLayoutMainScreenSucc(this.localStream)}).catch(()=>{s(),this.setMixLayoutMainScreenFail(this.localStream)})}signalingMessage({video:e,audio:t},s=(()=>{}),i=(()=>{})){this.deviceStatus={video:e,audio:t},this.localStream&&this.socketRtc.sendMessage("signaling_message",{streamId:this.localStream.streamId,msg:{type:"updatestream",config:{muteStream:{video:!e,audio:!t},localStream:!0}}}).then(()=>{s(),this.signalingMessageSucc(this.localStream)}).catch(()=>{i(),this.signalingMessageFail(this.localStream)})}initiativeReconnect(){this.socketRtc.initiativeReconnect()}startRoomBroadCast(e=(()=>{}),t=(()=>{})){this.socketRtc.sendMessage("StartRoomBroadCast",this.roomId).then(()=>{e()}).catch(()=>{t()})}stopRoomBroadCast(e=(()=>{}),t=(()=>{})){this.socketRtc.sendMessage("StopRoomBroadCast",this.roomId).then(()=>{e()}).catch(()=>{t()})}}const ae={EVENT_ROOM_ERROR:"EVENT_ROOM_ERROR",EVENT_ROOM_RECONNECTING:"EVENT_ROOM_RECONNECTING",EVENT_ROOM_RECONNECTFAIL:"EVENT_ROOM_RECONNECTFAIL",EVENT_ROOM_RECONNECTED:"EVENT_ROOM_RECONNECTED",EVENT_ROOM_CLOSE:"EVENT_ROOM_CLOSE",EVENT_ROOM_AUTH:"EVENT_ROOM_AUTH",EVENT_ROOM_BLACKLIST:"EVENT_ROOM_BLACKLIST",EVENT_ROOM_INVITED:"EVENT_ROOM_INVITED",EVENT_ROOM_APPLY:"EVENT_ROOM_APPLY",EVENT_ROOM_CALLBACK:"EVENT_ROOM_CALLBACK",EVENT_ROOM_JOIN:"EVENT_ROOM_JOIN",EVENT_ROOM_LEAVE:"EVENT_ROOM_LEAVE",EVENT_PUSHERSUCC:"EVENT_PUSHERSUCC",EVENT_PUSHERERROR:"EVENT_PUSHERERROR",EVENT_PLAYERSUCC:"EVENT_PLAYERSUCC",EVENT_PLAYERREEOR:"EVENT_PLAYERREEOR",EVENT_REMOTESTREAM_ADD:"EVENT_REMOTESTREAM_ADD",EVENT_REMOTESTREAM_REMOVED:"EVENT_REMOTESTREAM_REMOVED",FORCE_LEAVE_INAV:"FORCE_LEAVE_INAV",BROADCAST_VIDEO_PROFILE_480P_0:{resolution:[640,480],framerate:25,bitrate:600},BROADCAST_VIDEO_PROFILE_480P_1:{resolution:[852,480],framerate:25,bitrate:725},BROADCAST_VIDEO_PROFILE_540P_0:{resolution:[720,540],framerate:25,bitrate:775},BROADCAST_VIDEO_PROFILE_540P_1:{resolution:[960,540],framerate:25,bitrate:900},BROADCAST_VIDEO_PROFILE_720P_0:{resolution:[960,720],framerate:25,bitrate:1050},BROADCAST_VIDEO_PROFILE_720P_1:{resolution:[1280,720],framerate:25,bitrate:1100},BROADCAST_VIDEO_PROFILE_960P_0:{resolution:[1280,960],framerate:25,bitrate:1300},BROADCAST_VIDEO_PROFILE_1080P_0:{resolution:[1440,1080],framerate:25,bitrate:1350},BROADCAST_VIDEO_PROFILE_1080P_1:{resolution:[1920,1080],framerate:25,bitrate:1600},CROP_TYPE_NONE:0,CROP_TYPE_1_1:1,CROP_TYPE_4_3:2,CROP_TYPE_16_9:3,CROP_TYPE_AUTO:4,CANVAS_LAYOUT_PATTERN_GRID_1:0,CANVAS_LAYOUT_PATTERN_GRID_2_H:1,CANVAS_LAYOUT_PATTERN_GRID_3_E:2,CANVAS_LAYOUT_PATTERN_GRID_3_D:3,CANVAS_LAYOUT_PATTERN_GRID_4_M:4,CANVAS_LAYOUT_PATTERN_GRID_5_D:5,CANVAS_LAYOUT_PATTERN_GRID_6_E:6,CANVAS_LAYOUT_PATTERN_GRID_9_E:7,CANVAS_LAYOUT_PATTERN_FLOAT_2_1DR:8,CANVAS_LAYOUT_PATTERN_FLOAT_2_1DL:9,CANVAS_LAYOUT_PATTERN_FLOAT_3_2DL:10,CANVAS_LAYOUT_PATTERN_FLOAT_6_5D:11,CANVAS_LAYOUT_PATTERN_FLOAT_6_5T:12,CANVAS_LAYOUT_PATTERN_TILED_5_1T4D:13,CANVAS_LAYOUT_PATTERN_TILED_5_1D4T:14,CANVAS_LAYOUT_PATTERN_TILED_5_1L4R:15,CANVAS_LAYOUT_PATTERN_TILED_5_1R4L:16,CANVAS_LAYOUT_PATTERN_TILED_6_1T5D:17,CANVAS_LAYOUT_PATTERN_TILED_6_1D5T:18,CANVAS_LAYOUT_PATTERN_TILED_9_1L8R:19,CANVAS_LAYOUT_PATTERN_TILED_9_1R8L:20,CANVAS_LAYOUT_PATTERN_TILED_13_1L12R:21,CANVAS_LAYOUT_PATTERN_TILED_17_1TL16GRID:22,CANVAS_LAYOUT_PATTERN_TILED_9_1D8T:23,CANVAS_LAYOUT_PATTERN_TILED_13_1TL12GRID:24,CANVAS_LAYOUT_PATTERN_TILED_17_1TL16GRID_E:25,CANVAS_LAYOUT_PATTERN_CUSTOM:27,CANVAS_LAYOUT_EX_PATTERN_GRID_12_E:28,CANVAS_LAYOUT_EX_PATTERN_GRID_16_E:29,...v};class re extends g{constructor(e){super();for(let e in ae)this[e]=ae[e];this.requestApi=e.requestApi,this.room=null,this.upLogUrl=e.upLogUrl,this.app_id=e.app_id,this.accountId=e.accountId,this.inavId=e.inavId,this.byPassUrl=e.byPassUrl,this.vhallBase=e.vhallBase,this.streamMap={},this.roomInfo={local:{user:{accountId:this.accountId,streams:[]}},remote:{users:[]}}}close(){try{this.room.roomClose()}catch(e){console.warn(e)}}addRoomListener(){this.room.on("streamAdd",e=>{if(this.roomInfo.local.user.accountId!=e.getUserId()){for(let t of this.roomInfo.remote.users)if(t.accountId==e.getUserId()){t.streams.push({streamId:e.getId(),status:0});break}this.streamMap[e.getId()]=e,this.emit(this.EVENT_REMOTESTREAM_ADD,{streamId:e.getId(),userId:e.getUserId()})}else for(let t of this.roomInfo.local.user.streams)if(t.streamId==e.getId()){t.status=1;break}}),this.room.on("streamRemoved",({stream:e})=>{for(let t of this.roomInfo.remote.users)for(let s in t.streams)t.streams[s].streamId==e.getId()&&t.streams.splice(s,1);this.emit(this.EVENT_REMOTESTREAM_REMOVED,{streamId:e.getId(),userId:e.getUserId()})}),this.room.on(this.BROADCASTMUTESTREAM,e=>{this.emit(this.BROADCASTMUTESTREAM,e)}),this.room.on("onClose",e=>{this.emit(this.EVENT_ROOM_CLOSE,e)}),this.room.on("reConnecting",e=>{this.emit(this.EVENT_ROOM_RECONNECTING,e)}),this.room.on("reConnected",e=>{this.emit(this.EVENT_ROOM_RECONNECTED,e)}),this.room.on("reConnecting",e=>{this.emit(this.EVENT_ROOM_RECONNECTFAIL,e)}),this.room.on("onError",e=>{this.emit(this.EVENT_ROOM_ERROR,e)}),this.room.on("streamPublished",({streamId:e})=>{})}roomConnect(e){const t={token:e.token,upLogUrl:this.upLogUrl,biz_role:e.biz_role,biz_id:e.biz_id,biz_des01:e.biz_des01,bu:1,vid:this.accountId,app_id:this.app_id,vhallBase:this.vhallBase};return this.room=new ie(t),this.addRoomListener(),new Promise((e,t)=>{this.room.connect({attributes:""},t=>{for(let e of t.streams){for(let t of this.roomInfo.remote.users)if(t.accountId==e.getUserId()){const s=t.streams.findIndex(t=>t.streamId==e.getId());-1!=s&&t.streams.splice(s,1),t.streams.push({streamId:e.getId(),status:0,enableCamera:!e.muteStream.video,enableMic:!e.muteStream.audio})}this.streamMap[e.getId()]=e}e(t)},e=>{t(e)})})}getRoom(){return this.room}streamsIds(){return Object.keys(this.streamMap)}addUser(e){for(let t in this.roomInfo.remote.users)this.roomInfo.remote.users[t].accountId===e.userId&&this.roomInfo.remote.users.splice(t,1);let t={accountId:e.userId,streams:[]};for(let s in this.streamMap)this.streamMap[s].getUserId()==e.userId&&t.streams.push({streamId:s,status:0,enableCamera:!this.streamMap[s].muteStream.video,enableMic:!this.streamMap[s].muteStream.audio});this.roomInfo.remote.users.push(t),this.emit(this.EVENT_ROOM_JOIN,{userId:e.userId})}delUser(e){for(let t in this.roomInfo.remote.users)this.roomInfo.remote.users[t].accountId===e.userId&&this.roomInfo.remote.users.splice(t,1);for(let t in this.streamMap)this.streamMap[t].getUserId()===e.userId&&delete this.streamMap[t];this.emit(this.EVENT_ROOM_LEAVE,{userId:e.userId})}publish(e,t=(()=>{}),s=(()=>{})){return new Promise((e,i)=>{this.room.publish(({streamId:s,url:i})=>{this.roomInfo.local.user.streams.push({streamId:s,status:1});for(let e of this.roomInfo.remote.users)if(e.accountId==this.accountId){e.streams.push({streamId:s,status:1});break}t({streamId:s,url:i}),e({streamId:s,url:i})},e=>{s(e),i(e)})})}unpublish(e,t=(()=>{}),s=(()=>{})){return new Promise((e,i)=>{this.room.unpublish(()=>{this.roomInfo.local.user.streams=[];for(let e of this.roomInfo.remote.users)if(e.accountId==this.accountId){e.streams=[];break}t(),e()},e=>{s(e),i(e)})})}subscribe({streamId:e},t=(()=>{}),s=(()=>{})){let i=this.streamMap[e];return new Promise((a,r)=>{this.room.subscribe(i,s=>{e:for(let t of this.roomInfo.remote.users)if(t.accountId==i.getUserId())for(let s of t.streams)if(s.streamId==e){s.status=1;break e}t(s),a(s)},e=>{s(e),r(e)})})}generatePLIPacket(e){this.room.generatePLIPacket(e)}unsubscribe({streamId:e},t=(()=>{}),s=(()=>{})){let i=this.streamMap[e];return new Promise((a,r)=>{this.room.unsubscribe(i,()=>{e:for(let t of this.roomInfo.remote.users)if(t.accountId==i.getUserId())for(let s of t.streams)if(s.streamId==e){s.status=0;break e}t(),a()},e=>{s(e),r(e)})})}getRoomInfo(){return function e(t,s=[]){if(null===t||"object"!=typeof t)return t;const i=s.filter(e=>e.original===t)[0];if(i)return i.copy;const a=Array.isArray(t)?[]:{};return s.push({original:t,copy:a}),Object.keys(t).forEach(i=>{a[i]=e(t[i],s)}),a}(this.roomInfo)}startBroadCast({layoutMode:e,profile:t,roomId:s},i=(()=>{}),a=(()=>{})){let r={type:1,room_id:s,inav_id:this.inavId};return new Promise((n,h)=>{this.requestApi(o,r).then(()=>{this.room.configRoomBroadCast({layoutMode:e,profile:t,publishUrl:this.byPassUrl},()=>{i(),n()},()=>{a({code:"611017",message:"开启旁路失败",data:{}}),h({code:"611017",message:"开启旁路失败",data:{}}),this.stopBroadCast({roomId:s})})}).catch(()=>{a({code:"611017",message:"开启旁路失败",data:{}}),h({code:"611017",message:"开启旁路失败",data:{}})})})}stopBroadCast(e,t=(()=>{}),s=(()=>{})){const i={type:2,room_id:e.roomId,inav_id:this.inavId};return new Promise((e,a)=>{this.requestApi(o,i).then(()=>{t(),e()}).catch(()=>{s({code:"611016",message:"停止旁路失败",data:{}}),a({code:"611016",message:"停止旁路失败",data:{}})})})}setBroadCastLayout(e,t=(()=>{}),s=(()=>{})){return new Promise((i,a)=>{this.room.setMixLayoutMode(e.layout,()=>{t(),i()},()=>{s({code:"611018",message:"切换旁路推流布局失败",data:{}}),a({code:"611018",message:"切换旁路推流布局失败",data:{}})})})}setBroadCastScreen({mainScreenStreamId:e},t=(()=>{}),s=(()=>{})){return new Promise((i,a)=>{this.room.setMixLayoutMainScreen(e,()=>{t(),i()},()=>{s({code:"611018",message:"切换旁路推流主屏失败",data:{}}),a({code:"611018",message:"切换旁路推流主屏失败",data:{}})})})}apply(e,t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId};return new Promise((e,a)=>{this.requestApi(h,i).then(()=>{t(),e()}).catch(e=>{s({code:"611024",message:"申请上麦失败",data:e}),a({code:"611024",message:"申请上麦失败",data:e})})})}consentApply({userId:e},t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,audit_user_id:e,audit_type:1};return new Promise((e,a)=>{this.requestApi(n,i).then(()=>{t(),e()}).catch(e=>{s({code:"611019",message:"同意申请上麦失败",data:e}),a({code:"611019",message:"同意申请上麦失败",data:e})})})}rejectApply({userId:e},t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,audit_user_id:e,audit_type:2};return new Promise((e,a)=>{this.requestApi(n,i).then(()=>{t(),e()}).catch(e=>{s({code:"611020",message:"拒绝申请上麦失败",data:e}),a({code:"611020",message:"拒绝申请上麦失败",data:e})})})}invite({userId:e},t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,askfor_third_user_id:e};return new Promise((e,a)=>{this.requestApi(l,i).then(()=>{t(),e()}).catch(e=>{s({code:"611021",message:"邀请上麦失败",data:e}),a({code:"611021",message:"邀请上麦失败",data:e})})})}consentInvite(e,t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,stream_id:"",type:1};return new Promise((e,a)=>{this.requestApi(c,i).then(()=>{t(),e()}).catch(e=>{s({code:"611022",message:"同意被邀请上麦失败",data:{}}),a({code:"611022",message:"同意被邀请上麦失败",data:{}})})})}rejectInvite(e,t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,stream_id:"",type:3};return new Promise((e,a)=>{this.requestApi(c,i).then(()=>{t(),e()}).catch(e=>{s({code:"611023",message:"拒绝被邀请上麦失败",data:{}}),a({code:"611023",message:"拒绝被邀请上麦失败",data:{}})})})}getBlackList(e={},t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId};return new Promise((e,a)=>{this.requestApi(m,i).then(i=>{200==i.code?(t(i.data.lists),e(i.data.lists)):(s({code:"611025",message:"获取黑名单列表失败",data:i}),a({code:"611025",message:"获取黑名单列表失败",data:i}))}).catch(e=>{s({code:"611025",message:"获取黑名单列表失败",data:e}),a({code:"611025",message:"获取黑名单列表失败",data:e})})})}addBlackList({userId:e},t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,type:1,kick_user_id:e};return new Promise((e,a)=>{this.requestApi(d,i).then(()=>{t(),e()}).catch(e=>{s({code:"611027",message:"添加用户进黑名单失败",data:{}}),a({code:"611027",message:"添加用户进黑名单失败",data:{}})})})}removeBlackList({userId:e},t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,type:2,kick_user_id:e};return new Promise((e,a)=>{this.requestApi(d,i).then(()=>{t(),e()}).catch(e=>{s({code:"611028",message:"移除黑名单用户失败",data:{}}),a({code:"611028",message:"移除黑名单用户失败",data:{}})})})}setDeviceStatus({enableCamera:e=!0,enableMic:t=!0},s=(()=>{}),i=(()=>{})){return new Promise((a,r)=>{if("boolean"!=typeof e||"boolean"!=typeof t)return i({code:611029,message:"enableCamera和enableMic必须是Boolean类型"}),void r({code:611029,message:"enableCamera和enableMic必须是Boolean类型"});const o={video:e,audio:t};this.room.signalingMessage(o,()=>{s(),a()},e=>{i(e),r(e)})})}}class oe extends g{constructor({pusherId:e=null,THIS:t=null,room:s={}}){super(),this.pusherId=e,this.THIS=t,this.room=s}toAwait(e){return e.then(e=>[null,e]).catch(e=>[e])}destroy(){}getPusher(){return wx.createLivePusherContext(this.pusherId,this.THIS)}start(e){this.room.generalAddStream(this.room.localStream,"livePusher"),this.getPusher().start(e)}stop(e){this.getPusher().stop(e)}pause(e){this.getPusher().pause(e),this.room.generalChangeReportMsg({name:"livePusher",attr:"reportAllowed",value:!1})}resume(e){this.getPusher().resume(e),this.room.generalChangeReportMsg({name:"livePusher",attr:"reportAllowed",value:!0})}switchCamera(e){this.getPusher().switchCamera(e)}snapshot(e){this.getPusher().snapshot(e)}toggleTorch(e){this.getPusher().toggleTorch(e)}playBGM(e){this.getPusher().playBGM(e)}pauseBGM(e){this.getPusher().pauseBGM(e)}resumeBGM(e){this.getPusher().resumeBGM(e)}stopBGM(e){this.getPusher().stopBGM(e)}setBGMVolume(e){this.getPusher().setBGMVolume(e)}setMICVolume(e){this.getPusher().setMICVolume(e)}startPreview(e){this.getPusher().startPreview(e)}stopPreview(e){this.getPusher().stopPreview(e)}sendMessage(e){this.getPusher().sendMessage(e)}pusherStatechange({detail:e}){switch(e.code){case-1307:case 3001:case 3002:case 3003:case 3004:case 3005:Object.keys(this.room.reportMessage.livePusher).length&&(this.room.pusherConnectionFail(e),this.emit("pusherFail",e));break;case 1002:this.emit("pusherSucc")}}pusherNetstatus({detail:{info:e}}){Object.keys(this.room.reportMessage.livePusher).length&&this.room.generalChangeReportMsg({name:"livePusher",attr:"info",value:e})}pusherror(){}bgmstart(){}bgmprogress(){}bgmcomplete(){}}class ne extends g{constructor({THIS:e=null,room:t={}}){super(),this.THIS=e,this.room=t}getPlayer(e){return wx.createLivePlayerContext(e,this.THIS)}play({playerId:e,streamId:t},s){this.getPlayer(e).play(s),this.room.generalAddStream(this.room.remoteStreams[t])}pause({playerId:e,streamId:t},s){this.getPlayer(e).pause(s),this.room.generalChangeReportMsg({name:"livePlayer",key:t,attr:"reportAllowed",value:!1})}resume({playerId:e,streamId:t},s){this.getPlayer(e).resume(s),this.room.generalChangeReportMsg({name:"livePlayer",key:t,attr:"reportAllowed",value:!0})}stop({playerId:e,streamId:t},s){this.getPlayer(e).stop(s),this.room.unsubscribe({streamId:t})}requestFullScreen({playerId:e},t){this.getPlayer(e).requestFullScreen(t)}exitFullScreen({playerId:e},t){this.getPlayer(e).exitFullScreen(t)}mute({playerId:e},t){this.getPlayer(e).mute(t)}snapshot({playerId:e},t){this.getPlayer(e).snapshot(t)}playerStatechange(e){const t=e.currentTarget.dataset.streamId||"";switch(e.detail.code){case-2301:case-2302:case 2101:case 2102:case 3001:case 3002:case 3003:case 3004:case 3005:t&&this.room.reportMessage.livePlayer[t]&&(this.room.playerConnectionFail({streamId:t,code:e.detail.code}),this.emit("playerFail",{streamId:t,playerId:e.currentTarget.id}));break;case 2004:this.emit("playerSucc",{streamId:t,playerId:e.currentTarget.id})}}playerNetstatus(e){const t=e.currentTarget.dataset.streamid||"";t&&this.room.reportMessage.livePlayer[t]&&this.room.generalChangeReportMsg({name:"livePlayer",key:t,attr:"info",value:e.detail.info})}request(e){return new Promise((t,s)=>{wx.request({url:e,method:"GET",success:e=>{const i=e.data;if(200!==i.code)return console.error("call sdk api failed, code =",i.code),void s(i);t(i.data)},fail:e=>{console.error("call sdk api failed!!"),s(e)}})})}}class he{constructor(){this.vhallBase=null,this.inavInstance=null,this.requestApi=this.requestApi.bind(this)}requestApi(e,t){return new Promise((s,i)=>{this.request(e,t,e=>{s(e)},e=>{i(e)})})}connectMessageService(){try{this.vhallBase.on("Join",e=>{this.checkChannelId(e)&&this.inavInstance.addUser({userId:e.third_party_user_id})}),this.vhallBase.on("Leave",e=>{e.third_party_user_id!=this.accountId&&this.checkChannelId(e)&&this.inavInstance.delUser({userId:e.third_party_user_id})}),this.vhallBase.on("Inav",e=>{switch(e.data.inav_event){case"apply_inav_publish":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_APPLY,{userId:e.third_party_user_id});break;case"audit_inav_publish":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_AUTH,{userId:e.data.third_party_user_id,status:e.data.status,type:e.data.type});break;case"askfor_inav_publish":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_INVITED,{userId:e.data.third_party_user_id});break;case"kick_inav":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_BLACKLIST,{userId:e.data.third_party_user_id});break;case"user_publish_callback":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_CALLBACK,{userId:e.data.third_party_user_id,status:e.data.status,type:e.data.type});break;case"inav_close":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_CLOSE,{})}}),this.vhallBase.on("service_room",e=>{const{inav_event:t,third_party_user_id:s}=JSON.parse(e.data);"force_leave_inav"==t&&s==this.accountId&&this.inavInstance.emit(this.inavInstance.FORCE_LEAVE_INAV)}),this.vhallBase.on("connectFail",e=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_ERROR,e)}),this.vhallBase.on("onClose",e=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_CLOSE,e)}),this.vhallBase.on("reConnecting",()=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_RECONNECTING)}),this.vhallBase.on("reConnected",()=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_RECONNECTED)}),this.vhallBase.on("reConnectFail",()=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_RECONNECTFAIL)}),this.vhallBase.on("onError",e=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_ERROR,e)})}catch(e){}return Promise.resolve()}destroy(){try{this.vhallBase.close()}catch(e){console.warn(e)}}onComponent(){this.livePusher.on("pusherFail",e=>{this.inavInstance.emit(this.inavInstance.EVENT_PUSHERERROR,e)}),this.livePusher.on("pusherSucc",()=>{this.inavInstance.emit(this.inavInstance.EVENT_PUSHERSUCC)}),this.livePlayer.on("playerFail",e=>{this.inavInstance.emit(this.inavInstance.EVENT_PLAYERREEOR,e)}),this.livePlayer.on("playerSucc",e=>{this.inavInstance.emit(this.inavInstance.EVENT_PLAYERSUCC,e)})}async createInstance(e,t=(()=>{}),s=(()=>{})){const{inavId:o,appId:n,accountId:h,token:l,roomId:c,vhallBase:d,livePusherId:m=null,THIS:g=null}=e;if("string"!=typeof n)return s({code:"",message:"appId must be a string",data:{}}),Promise.reject({code:201,msg:"appId must be a string"});if("string"!=typeof o)return s({code:"",message:"inavId must be a string",data:{}}),Promise.reject({code:201,msg:"inavId must be a string"});if("string"!=typeof h)return s({code:"",message:"accountId must be a string",data:{}}),Promise.reject({code:201,msg:"accountId must be a string"});if("string"!=typeof l)return s({code:"",message:"token must be a string",data:{}}),Promise.reject({code:201,msg:"token must be a string"});if("string"!=typeof c)return s({code:"",message:"roomId must be a string",data:{}}),Promise.reject({code:201,msg:"roomId must be a string"});if("string"!=typeof m)return s({code:"",message:"livePusherId must be a string",data:{}}),Promise.reject({code:201,msg:"livePusherId must be a string"});if("[object Object]"!=Object.prototype.toString.call(d))return s({code:"",message:"vhallBase must be a object",data:{}}),Promise.reject({code:201,msg:"vhallBase must be a object"});let _={};_.roomId=c,_.appId=n,_.thirdPartyUserId=h,_.accessToken=l,_.channelId=o,this.inavId=o,this.request=new i(_).requestApi,this.vhallBase=d,this.accountId=h;const p=d.socketName,v=d.collect.has(p.CHAT);try{await this.requestApi(u,{inav_id:o,kick_user_id:h});const{data:{pushUrl:s,inav_token:i}}=await this.requestApi(a,{inav_id:o});v||await d.connectSocketIo({}),await d.addChannel(o),await this.delay(),d.join(p.CHAT,{third_party_user_id:h,channelId:o});const l={upLogUrl:d.store.getKV("log_server"),app_id:n,accountId:h,inavId:o,byPassUrl:s,requestApi:this.requestApi,vhallBase:d};this.inavInstance=new re(l);const c={token:i,biz_role:e.biz_role||0,biz_id:e.biz_id||0,biz_des01:e.biz_des01||0};await this.inavInstance.roomConnect(c),await this.connectMessageService(h);const{data:{lists:_}}=await this.requestApi(r,{inav_id:o});for(let e of _)this.inavInstance.addUser({userId:e.third_party_user_id});this.livePusher=new oe({pusherId:m,THIS:g,room:this.inavInstance.getRoom()}),this.livePlayer=new ne({THIS:g,room:this.inavInstance.getRoom()}),this.onComponent();let I={vhallrtc:this.inavInstance,streams:this.inavInstance.streamsIds(),livePusher:this.livePusher,livePlayer:this.livePlayer};return t(I),Promise.resolve(I)}catch(e){try{this.vhallBase.close()}catch(e){}return s(e),Promise.reject(e)}}checkChannelId(e){return e.channel==this.inavId}async initiativeReconnect(){return this.vhallBase.join(this.vhallBase.socketName.CHAT,{third_party_user_id:this.accountId,channelId:this.inavId}),Promise.resolve()}delay(e=1e3){return new Promise(t=>{setTimeout(()=>{t()},e)})}}}]);