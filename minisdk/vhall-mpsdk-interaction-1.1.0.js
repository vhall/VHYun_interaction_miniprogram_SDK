module.exports=function(e){var t={};function s(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(i,r,function(t){return e[t]}.bind(null,r));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t),s.d(t,"default",(function(){return he}));class i{constructor(e){this.requestParams={room_id:e.roomId||"",app_id:e.appId,third_party_user_id:e.thirdPartyUserId,access_token:e.accessToken,channelId:e.channelId,package_check:"peter",client:"wechat_applet"},this.host="https://api.vhallyun.com/sdk",this.requestApi=this.requestApi.bind(this)}requestApi(e,t,s,i){wx.request({url:`${this.host}${e}`,data:{...t,...this.requestParams},method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},success:e=>{e.statusCode>=400?i({code:400,message:"调用接口失败"}):200!==e.data.code?i(e.data):s(e.data)},fail:i})}}const r="/v1/inav/get-inav-info",a="/v1/inav/inav-user-list",n="/v1/inav/publish-inav-another",o="/v1/inav/audit-inav-publish",h="/v1/inav/apply-inav-publish",c="/v1/inav/askfor-inav-publish",l="/v1/inav/user-publish-callback",d="/v1/inav/kick-inav",u="/v1/inav/get-kick-inav-list";class _{constructor(){this.dispatcher={eventListeners:{}}}on(e,t){void 0===this.dispatcher.eventListeners[e]&&(this.dispatcher.eventListeners[e]=[]),this.dispatcher.eventListeners[e].push(t)}off(e,t){if(!this.dispatcher.eventListeners[e])return;const s=this.dispatcher.eventListeners[e].indexOf(t);-1!==s&&this.dispatcher.eventListeners[e].splice(s,1)}emit(e,t={}){if(!e)throw new Error("Undefined event");const s=this.dispatcher.eventListeners[e]||[];for(let e=0;e<s.length;e+=1)s[e](t)}}class m extends _{constructor(e){super(),this.options=e,this.orderNumber=0,this.socketStatus=!1,this.reconnectOut=null,this.heartInterval=null,this.reconnectTimes=0,this.customChat=e.customChat||!1,this.pingInterval=25e3,this.pingTimeout=6e4,this.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},this.initSocket=this.initSocket.bind(this),this.bindOpen=this.bindOpen.bind(this),this.bindMessage=this.bindMessage.bind(this),this.bindError=this.bindError.bind(this),this.bindClose=this.bindClose.bind(this),this.incrementNumber=this.incrementNumber.bind(this),this.send=this.send.bind(this),this.sendRtc=this.sendRtc.bind(this),this.close=this.close.bind(this)}initSocket(e=(()=>{}),t=(()=>{})){const s=this;this.socketTask=wx.connectSocket({url:this.options.url,success(t){e(t)},fail(e){t(e),s.stopHeart()}}),this.bindOpen(),this.bindMessage(),this.bindClose(),this.bindError()}bindOpen(){this.socketTask.onOpen(e=>{this.socketStatus=!0,this.emit("onOpen",e),this.reconnectTimes&&(this.emit("reConnected",e),this.reconnectTimes=0,clearTimeout(this.reconnectOut),this.reconnectOut=null),this.customChat&&this.startHeart()})}bindMessage(){this.socketTask.onMessage(e=>{if(!isNaN(Number(e.data)))return;const t=this.foramtMsg(e.data);t.needEmit&&this.emit("onMessage",t.data)})}bindError(){this.socketTask.onError(e=>{this.emit("onError",e)})}bindClose(){this.socketTask.onClose(e=>{this.socketStatus=!1,this.stopHeart(),this.emit("onClose",e),1e3!=e.code&&1001!=e.code&&1006!=e.code&&this.incrementNumber()})}send(e,t=!0){1==this.socketTask.readyState&&(t&&(e.data=`${this.packets.message}${this.packets.ping}["${e.name}",${JSON.stringify(e.data)}]`),this.socketTask.send(e))}sendRtc({data:e,name:t},s,i){1==this.socketTask.readyState&&(e=`${this.packets.message}${this.packets.ping}${this.orderNumber}["${t}",${JSON.stringify(e)}]`,this.on(`${this.packets.message}${this.packets.pong}${this.orderNumber}`,s),this.socketTask.send({data:e,fail:e=>{i(e)}}))}close(e={}){3!=this.socketTask.readyState&&(this.customChat&&this.socketTask.send({data:`${this.packets.message}${this.packets.close}`},!1),this.socketTask.close({code:1e3,...e}),this.stopHeart(),this.socketStatus=!1)}incrementNumber(){this.reconnectTimes++,this.reconnectTimes<6&&!this.socketStatus?(this.initSocket(),this.emit("reConnecting"),this.reconnectOut=setTimeout(this.incrementNumber,5e3)):(this.reconnectTimes=0,this.emit("reConnectFail"),clearTimeout(this.reconnectOut),this.reconnectOut=null)}foramtMsg(e){let t={needEmit:!0,data:{}};try{t.data=JSON.parse(e),t.data=decodeURIComponent(t.data.text)}catch(s){t.needEmit=!1;let i=parseInt(e);if(i<100){if(e.startsWith(`${this.packets.message}${this.packets.ping}`)){let t=e.substring(2);t=JSON.parse(t),this.emit(t[0],t[1]),this.emit("allSocket",{name:t[0],data:t[1]})}if(e.startsWith(`${this.packets.open}`)){let t=e.substring(1);t=JSON.parse(t),this.pingInterval=t.pingInterval,this.pingTimeout=t.pingTimeout}}else{i+="";const t=i.length;let s=e.substring(t);s=JSON.parse(s),this.emit(i,s[0]),this.off(i),this.orderNumber++}}return t}startHeart(){this.heartInterval||(this.heartInterval=setInterval(()=>{this.send({data:String(this.packets.ping)},!1)},this.pingInterval))}stopHeart(){this.heartInterval&&(clearInterval(this.heartInterval),this.heartInterval=null)}}class g extends class{constructor(){this.info={}}setKV(e,t){this.info[e]=t}getKV(e){return this.info[e]}deleteKey(e){this.info.hasOwnProperty(e)&&delete this.info[e]}reset(){this.info={}}toString(){let e=Object.keys(this.info),t="";return e.forEach(e=>{t+=`${e}:${this.info[e]} `}),t}}{constructor(e){super(),this.request=e.request,this.third_party_user_id=e.thirdPartyUserId,this.channelId=e.channelId,this.initAPI="/v1/init/start",this.sendAPI="/v2/message/send",this.pMsg=null,this.sMsg=null,this.events={msg:()=>{},onClose:()=>{},connectFail:()=>{},reConnectFail:()=>{},reConnecting:()=>{},onTaskError:()=>{},onError:()=>{},allSocket:()=>{}}}dispatch(e){let t;try{t="string"==typeof e?JSON.parse(e):e}catch(e){return}try{"function"==typeof this.events[t.event]?this.events[t.event](t):"function"==typeof this.events[t.service_type]?this.events[t.service_type](t):this.events.msg(t)}catch(e){return}}connectSocketIO(){this.sMsg=new m({url:`${this.getKV("socket_server").replace(/http/,"ws")}/socket.io/?token=${this.getKV("connection_token")}&EIO=3&transport=websocket`,customChat:!0}),this.sMsg.initSocket(()=>{},e=>{this.events.connectFail(e)}),this.sMsg.on("onMessage",e=>{this.dispatch(e)}),this.sMsg.on("msg",e=>{this.dispatch(e)}),this.sMsg.on("onOpen",()=>{this.join()}),this.sMsg.on("onClose",e=>{this.events.onClose(e)}),this.sMsg.on("onError",e=>{this.events.error(e),this.events.onTaskError(e)}),this.sMsg.on("reConnecting",()=>{this.events.reConnecting()}),this.sMsg.on("reConnected",()=>{this.events.reConnected()}),this.sMsg.on("reConnectFail",()=>{this.events.reConnectFail()}),this.sMsg.on("allSocket",e=>{this.events.allSocket(e)})}connectPushStream(){this.pMsg=new m({url:`${this.getKV("nginx_server").replace(/http/,"ws")}/ws/${this.channelId}?_=${(new Date).getTime()}&tag=0&time=&eventid=`}),this.pMsg.initSocket(()=>{},e=>{this.events.connectFail(e)}),this.pMsg.on("onOpen",()=>{}),this.pMsg.on("onMessage",e=>{this.dispatch(e)}),this.pMsg.on("onClose",e=>{this.events.onClose(e)}),this.pMsg.on("onError",e=>{this.events.error(e),this.events.onTaskError(e)}),this.pMsg.on("reConnecting",()=>{this.events.reConnecting()}),this.pMsg.on("reConnected",()=>{this.events.reConnected()}),this.pMsg.on("reConnectFail",()=>{this.events.reConnectFail()}),this.pMsg.on("allSocket",e=>{this.events.allSocket(e)})}init(e,t){this.request(this.initAPI,{},s=>{try{for(let e in s.data)this.setKV(e,s.data[e]);e()}catch(e){t(e)}},e=>{t(e)})}connect(e){this.connectPushStream(),this.connectSocketIO(),this.sMsg.on("joined",t=>{e(t)})}close(){try{this.leave(),this.pMsg.close(),this.sMsg.close()}catch(e){}this.pMsg=null,this.sMsg=null}on(e,t){this.events[e]=t}emit(e,t,s={},i=0,r=(()=>{}),a=(()=>{})){let n={type:e,channel_id:this.channelId,no_audit:i,body:"string"==typeof t?t:JSON.stringify(t),context:JSON.stringify(s)};this.request(this.sendAPI,n,e=>{r(e)},e=>{a(e)})}join(){if(!this.sMsg)return;const e={channel:this.channelId,third_party_user_id:this.third_party_user_id};this.sMsg.send({data:e,name:"join"})}leave(){if(!this.sMsg)return;const e={channel:this.channelId,third_party_user_id:this.third_party_user_id};this.sMsg.send({data:e,name:"leave"})}}class p extends _{constructor(){super(),this.socket=null}connect(e,t,s,i,r=(()=>{}),a=(()=>{})){this.socket=new m({url:`wss://${e.token.host.split(":443")[0]}/socket.io/?EIO=3&transport=websocket`,customChat:!0}),this.socket.initSocket(()=>{},e=>{a(e)}),this.socket.on("onOpen",()=>{const n={token:e,version:t,pf:s,attributes:i};setTimeout(()=>{this.sendMessage("token",n,e=>{r(e.msg)},a)},1e3)}),this.socket.on("onClose",e=>{this.emit("onClose",e)}),this.socket.on("reConnecting",()=>{this.emit("reConnecting",{})}),this.socket.on("reConnectFail",()=>{this.emit("reConnectFail",{})}),this.socket.on("onError",e=>{this.emit("onError",{})}),this.socket.on("allSocket",e=>{}),this.socket.on("onAddStream",e=>{this.emit("onAddStream",e)}),this.socket.on("onRemoveStream",e=>{this.emit("onRemoveStream",e)})}close(){try{this.socket.close()}catch(e){}}sendMessage(e,t,s=(()=>{}),i=(()=>{})){this.socket&&this.socket.sendRtc({name:e,data:t},e=>{"success"==e.result?s(e):i(e)},e=>{i(e)})}}const T="1.1.0",I="20200301",E=182001,A=182002,v=182003,b=182004,R=182006,S=182007,O=182014,P=182015,M=182021,C=182023,f=182024,N=182026,L=182027,y=182028,k=182029,V=182201,D=182202,U=182203,F=182204,w=182205,B=182206,Y=182601,x=184001,z=184003,$=184004,q=184008,G=184005,H=184007,j=184010,K=184012,J=184013,W=184201,X=184202,Q=184203;class Z{constructor(e){for(const t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}getId(){return this.streamId||""}getUser(){return this.user||{}}getUserId(){return this.user.id||""}}class ee{constructor(){this.END_OF_INPUT=-1,this.base64Chars=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],this.base64Str=null,this.base64Count=null,this.reverseBase64Chars=[];for(let e=0;e<this.base64Chars.length;e++)this.reverseBase64Chars[this.base64Chars[e]]=e}setBase64Str(e){this.base64Str=e,this.base64Count=0}readBase64(){if(!this.base64Str)return this.END_OF_INPUT;if(this.base64Count>=this.base64Str.length)return this.END_OF_INPUT;const e=255&this.base64Str.charCodeAt(this.base64Count);return this.base64Count+=1,e}readReverseBase64(){if(!this.base64Str)return this.END_OF_INPUT;for(;;){if(this.base64Count>=this.base64Str.length)return this.END_OF_INPUT;const e=this.base64Str.charAt(this.base64Count);if(this.base64Count+=1,this.reverseBase64Chars[e])return this.reverseBase64Chars[e];if("A"===e)return 0}}ntos(e){let t=e.toString(16);return 1===t.length&&(t=`0${t}`),t=`%${t}`,unescape(t)}encodeBase64(e){let t,s,i="";this.setBase64Str(e);const r=new Array(3);for(t=0,s=!1;!s&&(r[0]=this.readBase64())!==this.END_OF_INPUT;)r[1]=this.readBase64(),r[2]=this.readBase64(),i+=this.base64Chars[r[0]>>2],r[1]!==this.END_OF_INPUT?(i+=this.base64Chars[r[0]<<4&48|r[1]>>4],r[2]!==this.END_OF_INPUT?(i+=this.base64Chars[r[1]<<2&60|r[2]>>6],i+=this.base64Chars[63&r[2]]):(i+=this.base64Chars[r[1]<<2&60],i=`${i}=`,s=!0)):(i+=this.base64Chars[r[0]<<4&48],i=`${i}=`,i=`${i}=`,s=!0),t+=4,t>=76&&(i=`${i}\n`,t=0);return i}decodeBase64(e){let t,s="";this.setBase64Str(e);const i=new Array(4);for(t=!1;!t&&(i[0]=this.readReverseBase64())!==this.END_OF_INPUT&&(i[1]=this.readReverseBase64())!==this.END_OF_INPUT;)i[2]=this.readReverseBase64(),i[3]=this.readReverseBase64(),s+=this.ntos(i[0]<<2&255|i[1]>>4),i[2]!==this.END_OF_INPUT?(s+=this.ntos(i[1]<<4&255|i[2]>>2),i[3]!==this.END_OF_INPUT?s+=this.ntos(i[2]<<6&255|i[3]):t=!0):t=!0;return s}}class te{constructor(){this.sessionId=te.random(),this.message="",this.monitor_api="/monitor",this.reportMessage={livePusher:{},livePlayer:{}},this.interval=null,this.biz_des02=2,this.pf="9",this.ver=T,this.date=I,this.browerUA="miniprogram";const{brand:e,model:t,version:s,system:i,platform:r,SDKVersion:a}=wx.getSystemInfoSync();this.min_system={brand:e,model:t,version:s,system:i,platform:r,SDKVersion:a},this.base64=new ee,this.publishMessageLog=this.publishMessageLog.bind(this),this.playMessageLog=this.playMessageLog.bind(this),this.init=this.init.bind(this),this.upLogClose=this.upLogClose.bind(this),this.generalLog=this.generalLog.bind(this),this.generalAddStream=this.generalAddStream.bind(this),this.generalMessage=this.generalMessage.bind(this),this.connectSignallingLog=this.connectSignallingLog.bind(this),this.generalPush=this.generalPush.bind(this),this.reportVersion=this.reportVersion.bind(this),this.connectSignallingFailureLog=this.connectSignallingFailureLog.bind(this),this.sendPublish=this.sendPublish.bind(this),this.publishSuccess=this.publishSuccess.bind(this),this.sendSubscribe=this.sendSubscribe.bind(this),this.subscribeSuccess=this.subscribeSuccess.bind(this),this.upLogAddStream=this.upLogAddStream.bind(this),this.sendUnPublish=this.sendUnPublish.bind(this),this.unPublishSuccess=this.unPublishSuccess.bind(this),this.sendUnSubscribe=this.unSubscribeSuccess.bind(this),this.serverRemoveStream=this.serverRemoveStream.bind(this),this.upLogConfigRoomBroadCast=this.upLogConfigRoomBroadCast.bind(this),this.pushConfiguration=this.pushConfiguration.bind(this),this.pusherConnectionFail=this.pusherConnectionFail.bind(this),this.generalChangeReportMsg=this.generalChangeReportMsg.bind(this),this.playerConnectionFail=this.playerConnectionFail.bind(this),this.serverRemoveLocalStream=this.serverRemoveLocalStream.bind(this)}init(e){this.url=e.url?e.url:"https://t-dc.e.vhall.com/login",this.biz_role=e.biz_role,this.biz_id=e.biz_id,this.biz_des01=e.biz_des01,this.bu=e.bu,this.uid=e.uid,this.aid=e.aid,this.app_id=e.app_id,this.sd=e.sd;let t=this.url.split("/").length>=3?this.url.split("/")[2]:"t-dc.e.vhall.com";this.monitor_url=`https://${t}${this.monitor_api}`}static random(){const e=[1,2,3,4,5,6,7,8,9];return(new Date).valueOf()+String(e[Math.floor(Math.random()*e.length)])+String(e[Math.floor(Math.random()*e.length)])+String(e[Math.floor(Math.random()*e.length)])}push(e){wx.request({url:e,fail:e=>{console.error(`uplog failed!! ${e}`)}})}json2base64(e){return this.base64.encodeBase64(JSON.stringify(e).replace(/\s+/g,"")).replace(/\s+/g,"")}generalMessage(e={streamId:0}){return{s:this.sessionId,uid:this.uid,aid:this.aid,app_id:this.app_id,sd:this.sd,p:e&&e.streamId?e.streamId:0,pf:this.pf,ver:this.ver,bu:this.bu,min_system:this.min_system}}generalPush(e,t){const s=te.random(),i=this.json2base64(t),r=`${this.url}?k=${e}&id=${s}&s=${this.sessionId}&bu=${this.bu}&token=${i}`;this.push(r)}startInterval(){this.interval||(this.interval=setInterval(this.generalLog,3e4))}generalLog(){if(this.reportMessage.livePusher.reportAllowed){try{this.publishMessageLog(this.reportMessage.livePusher)}catch(e){console.warn(e)}this.generalChangeReportMsg({name:"livePusher",attr:"lastTime",value:Date.now()}),this.generalChangeReportMsg({name:"livePusher",attr:"needCalculation",value:!1})}for(const e in this.reportMessage.livePlayer)if(this.reportMessage.livePlayer.hasOwnProperty(e)){let t=this.reportMessage.livePlayer[e];if(t.reportAllowed){try{this.playMessageLog(t)}catch(e){console.warn(e)}t.lastTime=Date.now(),t.needCalculation=!1}}}generalAddStream(e,t="livePlayer"){"livePlayer"==t?this.reportMessage[t][e.streamId]={...e,needCalculation:!0,lastTime:Date.now(),reportAllowed:!0}:this.reportMessage[t]={...e,needCalculation:!0,lastTime:Date.now(),reportAllowed:!0},this.startInterval()}generalStopMessageLog(e,t="livePlayer",s=!1){if(s){try{this.publishMessageLog(this.reportMessage.livePusher)}catch(e){console.warn(e)}this.reportMessage.livePusher={}}if("livePlayer"==t){try{this.playMessageLog(this.reportMessage.livePlayer[e.streamId])}catch(e){console.warn(e)}delete this.reportMessage[t][e.streamId]}else{try{this.publishMessageLog(this.reportMessage.livePusher)}catch(e){console.warn(e)}this.reportMessage.livePusher={}}Object.keys(this.reportMessage.livePlayer).length||Object.keys(this.reportMessage.livePusher).length||(clearInterval(this.interval),this.interval=null)}upLogClose(){this.generalLog(),clearInterval(this.interval),this.interval=null}pushConfiguration(e,t){let s=this.generalMessage(t);s={...s,currentBitrateKbps:this.reportMessage.livePusher.info?this.reportMessage.livePusher.info.videoFPS:0,videoWidth:this.reportMessage.livePusher.info?this.reportMessage.livePusher.info.videoWidth:0,videoHeight:this.reportMessage.livePusher.info?this.reportMessage.livePusher.videoHeight:0,streamType:this.reportMessage.livePusher.streamType||2,videoCodecPreference:"H264"},this.generalPush(e,s)}generalChangeReportMsg({name:e,key:t,attr:s,value:i}){"livePusher"==e?this.reportMessage[e][s]=i:this.reportMessage[e][t][s]=i}sendPublish(){const e=this.generalMessage(),t=R;this.generalPush(t,e)}publishSuccess(e){const t=this.generalMessage(e),s=S;this.generalPush(s,t)}sendSubscribe(e){const t=this.generalMessage(e),s=O;this.generalPush(s,t)}subscribeSuccess(e){const t=this.generalMessage(e),s=P;this.generalPush(s,t)}upLogAddStream(e){const t=this.generalMessage(e),s=M;this.generalPush(s,t)}sendUnPublish(e){const t=this.generalMessage(e),s=C;this.generalPush(s,t)}unPublishSuccess(e){const t=this.generalMessage(e),s=f;this.generalPush(s,t)}sendUnSubscribe(e){const t=this.generalMessage(e),s=N;this.generalPush(s,t)}unSubscribeSuccess(e){const t=this.generalMessage(e),s=k;this.generalPush(s,t)}serverRemoveStream(e){const t=this.generalMessage(e),s=y;this.generalPush(s,t)}connectSignallingLog(){const e=E,t=this.generalMessage({streamId:0});this.generalPush(e,t)}upLogConfigRoomBroadCast(e){const t=V;this.pushConfiguration(t,e)}ConfigRoomBroadCastSucc(e){const t=D;this.pushConfiguration(t,e)}upLogSetMixLayoutMode(e){const t=U;this.pushConfiguration(t,e)}setMixLayoutModeSucc(e){const t=F;this.pushConfiguration(t,e)}upLogSetMixLayoutMainScreen(e){const t=w;this.pushConfiguration(t,e)}setMixLayoutMainScreenSucc(e){const t=B;this.pushConfiguration(t,e)}closeSignallingLog(){const e=A,t=this.generalMessage();this.generalPush(e,t)}playMessageLog(e){const t=v;let s=this.generalMessage(e);s={...s,tt:3e4,errorcode:2002,vtype:e.streamType,videoWidth:e.info.videoWidth,videoHeight:e.info.videoHeight,bitrate:parseInt(e.info.videoBitrate+e.info.audioBitrate),tf:30*(e.info.videoBitrate+e.info.audioBitrate)*1024/8,uf:0,biz_role:this.biz_role,biz_id:this.biz_id,biz_des01:this.biz_des01,biz_des02:this.biz_des02,os:!1},e.needCalculation&&(s.tt=Math.abs(Date.now()-e.lastTime)),this.generalPush(t,s)}publishMessageLog(e){const t=b;let s=this.generalMessage(e);s={...s,tt:3e4,errorcode:2003,vtype:e.streamType,videoWidth:e.info.videoWidth,videoHeight:e.info.videoHeight,bitrate:parseInt(e.info.videoBitrate+e.info.audioBitrate),tf:0,uf:30*(e.info.videoBitrate+e.info.audioBitrate)*1024/8,biz_role:this.biz_role,biz_id:this.biz_id,biz_des01:this.biz_des01,biz_des02:this.biz_des02,os:!1},e.needCalculation&&(s.tt=Math.abs(Date.now()-e.lastTime)),this.generalPush(t,s)}reportVersion(){const e=Y;let t=this.generalMessage();t={release_date:this.date,ua:this.browerUA,...t},this.generalPush(e,t)}connectSignallingFailureLog(){const e=x,t=this.generalMessage();this.generalPush(e,t)}publishError(){const e=z,t=this.generalMessage();this.generalPush(e,t)}serverRemoveLocalStream(e){const t=G,s=this.generalMessage(e);this.generalPush(t,s)}subscribeFail(e){const t=H,s=this.generalMessage(e);this.generalPush(t,s)}unPublishFail(e){const t=j,s=this.generalMessage(e);this.generalPush(t,s)}unSubscribeFail(e){const t=K,s=this.generalMessage(e);this.generalPush(t,s)}serverOffLine(e){const t=J;let s=this.generalMessage();s={...s,...e},this.generalPush(t,s)}configRoomBroadCastFail(e){const t=W,s=this.generalMessage(e);this.generalPush(t,s)}setMixLayoutModeFail(e){const t=X,s=this.generalMessage(e);this.generalPush(t,s)}setMixLayoutMainScreenFail(e){const t=Q,s=this.generalMessage(e);this.generalPush(t,s)}pusherConnectionFail(e){const t=$;let s=this.generalMessage(this.reportMessage.livePusher);s={...s,...e},this.generalPush(t,s)}playerConnectionFail(e){const t=q;let s=this.generalMessage(this.reportMessage.livePusher);s={...s,...e},this.generalPush(t,s)}closeSocketRtc(){const e=L,t=this.generalMessage(this.reportMessage.livePusher);this.generalPush(e,t)}}function se(e,t){for(let s of Reflect.ownKeys(t))if("constructor"!==s&&"prototype"!==s&&"name"!==s){let i=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,i)}}class ie extends(function(...e){class t{constructor(){for(let t of e)se(this,new t)}}for(let s of e)se(t,s),se(t.prototype,s.prototype);return t}(_,te)){constructor(e){super(),this.socketRtc=new p,this.spec=e,this.localStream=null,this.localuser=null,this.remoteStreams={},this.roomId="",this.isPublished=!1,this.rtmpUrl=null,this.base64=new ee,this.publish=this.publish.bind(this),this.configRoomBroadCast=this.configRoomBroadCast.bind(this),this.setMixLayoutMode=this.setMixLayoutMode.bind(this),this.setMixLayoutMainScreen=this.setMixLayoutMainScreen.bind(this),this.generatePLIPacket=this.generatePLIPacket.bind(this),this.unpublish=this.unpublish.bind(this),this.roomClose=this.roomClose.bind(this),this.initOnSocket()}initOnSocket(){this.socketRtc.on("onAddStream",e=>{this.socketOnAddStream(e)}),this.socketRtc.on("onRemoveStream",e=>{this.socketOnRemoveStream(e)}),this.socketRtc.on("onClose",e=>{this.socketRtcOnClose(e)}),this.socketRtc.on("reConnecting",()=>{this.socketOnReConnecting()}),this.socketRtc.on("reConnected",()=>{this.socketOnReConnected()}),this.socketRtc.on("reConnectFail",()=>{this.socketOnReConnectFail()}),this.socketRtc.on("onError",e=>{this.socketOnError(e)})}socketRtcOnClose(e){1e3!=e.code&&1001!=e.code&&1006!=e.code&&1005!=e.code&&this.serverOffLine(e),this.emit("onClose",e)}socketOnReConnecting(){this.emit("reConnecting")}socketOnReConnected(e){this.emit("reConnected",e)}socketOnReConnectFail(){this.emit("reConnectFail")}socketOnError(e){this.emit("onError",e)}socketOnAddStream(e){if(this.localStream&&e.id==this.localStream.streamId)return void this.emit("streamPublished",{stream:this.localStream});const t=new Z({state:e.state,sdp:e.sdp,streamId:e.id,local:!1,audio:e.audio,video:e.video,data:e.data,screen:e.screen,attributes:e.attributes,user:e.user,streamType:e.streamType});this.remoteStreams[e.id]=t,e.streamId=e.id,this.emit("streamAdd",t)}socketOnRemoveStream(e){if(this.localStream&&this.localStream.streamId==e.id)return void this.onStreamFailed(this.localStream);let t=this.remoteStreams[e.id];t&&(delete this.remoteStreams[e.id],this.emit("streamRemoved",{stream:t,msg:"Server Remove remote stream"}),e.streamId=e.id,this.serverRemoveStream(e))}onStreamFailed(e){this.serverRemoveLocalStream(e),this.emit("streamFailed",{msg:"Server Remove local stream",stream:e}),e.local?this.unpublish():this.unsubscribe(e)}connect(e,t=(()=>{}),s=(()=>{})){const i=this.base64.decodeBase64(this.spec.token);this.socketRtc.connect(JSON.parse(i),T,9,e.attributes,e=>{const s=[],r=e.streams||[];this.roomId=e.id,this.spec.defaultVideoBW=e.defaultVideoBW,this.spec.maxVideoBW=e.maxVideoBW,this.localuser=e.user;const a=Object.keys(r);for(let e=0;e<a.length;e++){const t=r[a[e]];let i=new Z({state:"rtmp",streamId:t.id,local:!1,audio:t.audio,video:t.video,data:t.data,screen:t.screen,attributes:t.attributes,user:t.user,streamType:t.streamType});s.push(i),this.remoteStreams[t.id]=i}const n={uid:this.localuser.id,aid:this.roomId,url:this.spec.upLogUrl,biz_role:this.spec.biz_role,biz_id:this.spec.biz_id,biz_des01:this.spec.biz_des01,bu:this.spec.bu,vid:this.spec.vid,app_id:this.spec.app_id?this.spec.app_id:0,sd:JSON.parse(i).token.host};this.init(n),this.connectSignallingLog(),this.reportVersion(),t({streams:s})},e=>{this.connectSignallingFailureLog(),s(e)})}roomClose(){this.unpublish(),this.socketRtc.close(),this.upLogClose()}publish(e=(()=>{}),t=(()=>{})){if(this.isPublished&&this.localStream)return void t("already pulished");this.isPublished=!0;const s={state:"rtmp",data:!0,audio:!0,video:!0,screen:!0,attributes:"",createOffer:!1,muteStream:{audio:!1,video:!1},minVideoBW:this.spec.defaultVideoBW,streamType:2};this.localStream=new Z({state:"rtmp",local:!0,audio:!0,video:!0,data:!0,screen:!1,attributes:"",user:this.localuser,streamType:2}),this.sendPublish(),this.socketRtc.sendMessage("publish",s,t=>{this.localStream.streamId=t.msg.streamId,this.localStream.sdp=t.msg.sdp,e({url:t.msg.sdp,streamId:t.msg.streamId}),this.publishSuccess(this.localStream),this.localStream.sdp},e=>{t(e),this.isPublished=!1,this.publishError()})}unpublish(e=(()=>{}),t=(()=>{})){if(this.isPublished=!1,!this.localStream)return void t("stream not found");let s={streamId:this.localStream.streamId};this.generalStopMessageLog(this.localStream,"livePusher"),this.sendUnPublish(this.localStream),this.socketRtc.sendMessage("unpublish",s,t=>{e(t),this.unPublishSuccess(s)},e=>{t(e),this.unPublishFail(s)}),this.localStream=null}subscribe(e,t=(()=>{}),s=(()=>{})){const i={state:"rtmp",sdp:e.sdp,streamId:e.streamId,data:!0,audio:!0,video:!0,createOffer:!1,muteStream:e.muteStream};this.sendSubscribe(i),this.socketRtc.sendMessage("subscribe",i,s=>{this.subscribeSuccess(i),t({streamId:e.streamId,url:s.msg.sdp})},e=>{s(e),this.subscribeFail(i)})}generatePLIPacket(e){this.socketRtc.sendMessage("generatePLIPacket",{streamId:e})}unsubscribe(e,t=(()=>{}),s=(()=>{})){const i={state:"rtmp",streamId:e.streamId};this.sendUnSubscribe(i),this.generalStopMessageLog(e),this.socketRtc.sendMessage("unsubscribe",i,e=>{this.unPublishSuccess(i),t()},e=>{s(e),this.unSubscribeFail(i)})}configRoomBroadCast(e,t=(()=>{}),s=(()=>{})){this.upLogConfigRoomBroadCast(this.localStream),this.socketRtc.sendMessage("ConfigRoomBroadCast",{config:JSON.stringify(e)},()=>{t(),this.ConfigRoomBroadCastSucc(this.localStream)},()=>{s(),this.configRoomBroadCastFail(this.localStream)})}setMixLayoutMode(e,t=(()=>{}),s=(()=>{})){this.upLogSetMixLayoutMode(this.localStream),this.socketRtc.sendMessage("SetMixLayoutMode",{roomID:this.roomId,config:e},()=>{t(),this.setMixLayoutModeSucc(this.localStream)},()=>{s(),this.setMixLayoutModeFail(this.localStream)})}setMixLayoutMainScreen(e,t=(()=>{}),s=(()=>{})){this.upLogSetMixLayoutMainScreen(this.localStream),this.socketRtc.sendMessage("SetMixLayoutMainScreen",{roomID:this.roomId,config:e},()=>{t(),this.setMixLayoutMainScreenSucc(this.localStream)},()=>{s(),this.setMixLayoutMainScreenFail(this.localStream)})}startRoomBroadCast(e=(()=>{}),t=(()=>{})){this.socketRtc.sendMessage("StartRoomBroadCast",this.roomId,()=>{e()},()=>{t()})}stopRoomBroadCast(e=(()=>{}),t=(()=>{})){this.socketRtc.sendMessage("StopRoomBroadCast",this.roomId,()=>{e()},()=>{t()})}}const re={EVENT_ROOM_ERROR:"EVENT_ROOM_ERROR",EVENT_ROOM_RECONNECTING:"EVENT_ROOM_RECONNECTING",EVENT_ROOM_RECONNECTFAIL:"EVENT_ROOM_RECONNECTFAIL",EVENT_ROOM_RECONNECTED:"EVENT_ROOM_RECONNECTED",EVENT_ROOM_CLOSE:"EVENT_ROOM_CLOSE",EVENT_ROOM_AUTH:"EVENT_ROOM_AUTH",EVENT_ROOM_BLACKLIST:"EVENT_ROOM_BLACKLIST",EVENT_ROOM_INVITED:"EVENT_ROOM_INVITED",EVENT_ROOM_APPLY:"EVENT_ROOM_APPLY",EVENT_ROOM_CALLBACK:"EVENT_ROOM_CALLBACK",EVENT_ROOM_JOIN:"EVENT_ROOM_JOIN",EVENT_ROOM_LEAVE:"EVENT_ROOM_LEAVE",EVENT_PUSHERSUCC:"EVENT_PUSHERSUCC",EVENT_PUSHERERROR:"EVENT_PUSHERERROR",EVENT_PLAYERSUCC:"EVENT_PLAYERSUCC",EVENT_PLAYERREEOR:"EVENT_PLAYERREEOR",EVENT_REMOTESTREAM_ADD:"EVENT_REMOTESTREAM_ADD",EVENT_REMOTESTREAM_REMOVED:"EVENT_REMOTESTREAM_REMOVED",EVENT_REMOTESTREAM_MUTE:"EVENT_REMOTESTREAM_MUTE",BROADCAST_VIDEO_PROFILE_480P_0:{resolution:[640,480],framerate:25,bitrate:600},BROADCAST_VIDEO_PROFILE_480P_1:{resolution:[852,480],framerate:25,bitrate:725},BROADCAST_VIDEO_PROFILE_540P_0:{resolution:[720,540],framerate:25,bitrate:775},BROADCAST_VIDEO_PROFILE_540P_1:{resolution:[960,540],framerate:25,bitrate:900},BROADCAST_VIDEO_PROFILE_720P_0:{resolution:[960,720],framerate:25,bitrate:1050},BROADCAST_VIDEO_PROFILE_720P_1:{resolution:[1280,720],framerate:25,bitrate:1100},BROADCAST_VIDEO_PROFILE_960P_0:{resolution:[1280,960],framerate:25,bitrate:1300},BROADCAST_VIDEO_PROFILE_1080P_0:{resolution:[1440,1080],framerate:25,bitrate:1350},BROADCAST_VIDEO_PROFILE_1080P_1:{resolution:[1920,1080],framerate:25,bitrate:1600},CROP_TYPE_NONE:0,CROP_TYPE_1_1:1,CROP_TYPE_4_3:2,CROP_TYPE_16_9:3,CROP_TYPE_AUTO:4,CANVAS_LAYOUT_PATTERN_GRID_1:0,CANVAS_LAYOUT_PATTERN_GRID_2_H:1,CANVAS_LAYOUT_PATTERN_GRID_3_E:2,CANVAS_LAYOUT_PATTERN_GRID_3_D:3,CANVAS_LAYOUT_PATTERN_GRID_4_M:4,CANVAS_LAYOUT_PATTERN_GRID_5_D:5,CANVAS_LAYOUT_PATTERN_GRID_6_E:6,CANVAS_LAYOUT_PATTERN_GRID_9_E:7,CANVAS_LAYOUT_PATTERN_FLOAT_2_1DR:8,CANVAS_LAYOUT_PATTERN_FLOAT_2_1DL:9,CANVAS_LAYOUT_PATTERN_FLOAT_3_2DL:10,CANVAS_LAYOUT_PATTERN_FLOAT_6_5D:11,CANVAS_LAYOUT_PATTERN_FLOAT_6_5T:12,CANVAS_LAYOUT_PATTERN_TILED_5_1T4D:13,CANVAS_LAYOUT_PATTERN_TILED_5_1D4T:14,CANVAS_LAYOUT_PATTERN_TILED_5_1L4R:15,CANVAS_LAYOUT_PATTERN_TILED_5_1R4L:16,CANVAS_LAYOUT_PATTERN_TILED_6_1T5D:17,CANVAS_LAYOUT_PATTERN_TILED_6_1D5T:18,CANVAS_LAYOUT_PATTERN_TILED_9_1L8R:19,CANVAS_LAYOUT_PATTERN_TILED_9_1R8L:20,CANVAS_LAYOUT_PATTERN_TILED_13_1L12R:21,CANVAS_LAYOUT_PATTERN_TILED_17_1TL16GRID:22,CANVAS_LAYOUT_PATTERN_TILED_9_1D8T:23,CANVAS_LAYOUT_PATTERN_TILED_13_1TL12GRID:24,CANVAS_LAYOUT_PATTERN_TILED_17_1TL16GRID_E:25,CANVAS_LAYOUT_PATTERN_CUSTOM:27,CANVAS_LAYOUT_EX_PATTERN_GRID_12_E:28,CANVAS_LAYOUT_EX_PATTERN_GRID_16_E:29};re[0]="CANVAS_LAYOUT_PATTERN_GRID_1",re[1]="CANVAS_LAYOUT_PATTERN_GRID_2_H",re[2]="CANVAS_LAYOUT_PATTERN_GRID_3_E",re[3]="CANVAS_LAYOUT_PATTERN_GRID_3_D",re[4]="CANVAS_LAYOUT_PATTERN_GRID_4_M",re[5]="CANVAS_LAYOUT_PATTERN_GRID_5_D",re[6]="CANVAS_LAYOUT_PATTERN_GRID_6_E",re[7]="CANVAS_LAYOUT_PATTERN_GRID_9_E",re[8]="CANVAS_LAYOUT_PATTERN_FLOAT_2_1DR",re[9]="CANVAS_LAYOUT_PATTERN_FLOAT_2_1DL",re[10]="CANVAS_LAYOUT_PATTERN_FLOAT_3_2DL",re[11]="CANVAS_LAYOUT_PATTERN_FLOAT_6_5D",re[12]="CANVAS_LAYOUT_PATTERN_FLOAT_6_5T",re[13]="CANVAS_LAYOUT_PATTERN_TILED_5_1T4D",re[14]="CANVAS_LAYOUT_PATTERN_TILED_5_1D4T",re[15]="CANVAS_LAYOUT_PATTERN_TILED_5_1L4R",re[16]="CANVAS_LAYOUT_PATTERN_TILED_5_1R4L",re[17]="CANVAS_LAYOUT_PATTERN_TILED_6_1T5D",re[18]="CANVAS_LAYOUT_PATTERN_TILED_6_1D5T",re[19]="CANVAS_LAYOUT_PATTERN_TILED_9_1L8R",re[20]="CANVAS_LAYOUT_PATTERN_TILED_9_1R8L",re[21]="CANVAS_LAYOUT_PATTERN_TILED_13_1L12R",re[22]="CANVAS_LAYOUT_PATTERN_TILED_17_1TL16GRID",re[23]="CANVAS_LAYOUT_PATTERN_TILED_9_1D8T",re[24]="CANVAS_LAYOUT_PATTERN_TILED_13_1TL12GRID",re[25]="CANVAS_LAYOUT_PATTERN_TILED_17_1TL16GRID_E";class ae extends _{constructor(e){super();for(let e in re)this[e]=re[e];this.requestApi=e.requestApi,this.room=null,this.upLogUrl=e.upLogUrl,this.app_id=e.app_id,this.accountId=e.accountId,this.inavId=e.inavId,this.byPassUrl=e.byPassUrl,this.streamMap={},this.roomInfo={local:{user:{accountId:this.accountId,streams:[]}},remote:{users:[]}}}close(){try{this.room.roomClose()}catch(e){console.warn(e)}}addRoomListener(){this.room.on("streamAdd",e=>{if(this.roomInfo.local.user.accountId!=e.getUserId()){for(let t of this.roomInfo.remote.users)if(t.accountId==e.getUserId()){t.streams.push({streamId:e.getId(),status:0});break}this.streamMap[e.getId()]=e,this.emit(this.EVENT_REMOTESTREAM_ADD,{streamId:e.getId(),userId:e.getUserId()})}else for(let t of this.roomInfo.local.user.streams)if(t.streamId==e.getId()){t.status=1;break}}),this.room.on("streamRemoved",({stream:e})=>{for(let t of this.roomInfo.remote.users)for(let s in t.streams)t.streams[s].streamId==e.getId()&&t.streams.splice(s,1);this.emit(this.EVENT_REMOTESTREAM_REMOVED,{streamId:e.getId(),userId:e.getUserId()})}),this.room.on("onClose",e=>{this.emit(this.EVENT_ROOM_CLOSE,e)}),this.room.on("reConnecting",e=>{this.emit(this.EVENT_ROOM_RECONNECTING,e)}),this.room.on("reConnected",e=>{this.emit(this.EVENT_ROOM_RECONNECTED,e)}),this.room.on("reConnecting",e=>{this.emit(this.EVENT_ROOM_RECONNECTFAIL,e)}),this.room.on("onError",e=>{this.emit(this.EVENT_ROOM_ERROR,e)}),this.room.on("streamPublished",({streamId:e})=>{})}roomConnect(e){const t={token:e.token,upLogUrl:this.upLogUrl,biz_role:e.biz_role,biz_id:e.biz_id,biz_des01:e.biz_des01,bu:1,vid:this.accountId,app_id:this.app_id};return this.room=new ie(t),this.addRoomListener(),new Promise((e,t)=>{this.room.connect({attributes:""},t=>{for(let e of t.streams){for(let t of this.roomInfo.remote.users)t.accountId===e.getUserId()&&t.streams.push({streamId:e.getId(),status:0});this.streamMap[e.getId()]=e}e(t)},e=>{t(e)})})}getRoom(){return this.room}streamsIds(){return Object.keys(this.streamMap)}addUser(e){for(let t in this.roomInfo.remote.users)this.roomInfo.remote.users[t].accountId===e.userId&&this.roomInfo.remote.users.splice(t,1);let t={accountId:e.userId,streams:[]};for(let s in this.streamMap)this.streamMap[s].getUserId()===e.userId&&t.streams.push({streamId:s,status:0});this.roomInfo.remote.users.push(t),this.emit(this.EVENT_ROOM_JOIN,{userId:e.userId})}delUser(e){for(let t in this.roomInfo.remote.users)this.roomInfo.remote.users[t].accountId===e.userId&&this.roomInfo.remote.users.splice(t,1);for(let t in this.streamMap)this.streamMap[t].getUserId()===e.userId&&delete this.streamMap[t];this.emit(this.EVENT_ROOM_LEAVE,{userId:e.userId})}publish(e,t=(()=>{}),s=(()=>{})){this.room.publish(({streamId:e,url:s})=>{this.roomInfo.local.user.streams.push({streamId:e,status:1});for(let t of this.roomInfo.remote.users)if(t.accountId==this.accountId){t.streams.push({streamId:e,status:1});break}t({streamId:e,url:s})},e=>{s(e)})}unpublish(e,t=(()=>{}),s=(()=>{})){this.room.unpublish(()=>{this.roomInfo.local.user.streams=[];for(let e of this.roomInfo.remote.users)if(e.accountId==this.accountId){e.streams=[];break}t()},e=>{s(e)})}subscribe({streamId:e},t=(()=>{}),s=(()=>{})){let i=this.streamMap[e];this.room.subscribe(i,s=>{e:for(let t of this.roomInfo.remote.users)if(t.accountId==i.getUserId())for(let s of t.streams)if(s.streamId==e){s.status=1;break e}t(s)},e=>{s(e)})}generatePLIPacket(e){this.room.generatePLIPacket(e)}unsubscribe({streamId:e},t=(()=>{}),s=(()=>{})){let i=this.streamMap[e];this.room.unsubscribe(i,()=>{e:for(let t of this.roomInfo.remote.users)if(t.accountId==i.getUserId())for(let s of t.streams)if(s.streamId==e){s.status=0;break e}t()},e=>{s(e)})}getRoomInfo(){return function e(t,s=[]){if(null===t||"object"!=typeof t)return t;const i=s.filter(e=>e.original===t)[0];if(i)return i.copy;const r=Array.isArray(t)?[]:{};return s.push({original:t,copy:r}),Object.keys(t).forEach(i=>{r[i]=e(t[i],s)}),r}(this.roomInfo)}startBroadCast({layoutMode:e,profile:t,roomId:s},i=(()=>{}),r=(()=>{})){let a={type:1,room_id:s,inav_id:this.inavId};this.requestApi(n,a).then(()=>{this.byPassUrl,this.room.configRoomBroadCast({layoutMode:e,profile:t,publishUrl:this.byPassUrl},()=>{i()},()=>{r({code:"611017",message:"开启旁路失败",data:{}}),this.stopBroadCast({roomId:s})})}).catch(()=>{r({code:"611017",message:"开启旁路失败",data:{}})})}stopBroadCast(e,t=(()=>{}),s=(()=>{})){const i={type:2,room_id:e.roomId,inav_id:this.inavId};this.requestApi(n,i).then(()=>{t()}).catch(()=>{s({code:"611016",message:"停止旁路失败",data:{}})})}setBroadCastLayout(e,t=(()=>{}),s=(()=>{})){this.room.setMixLayoutMode(e.layout,()=>{t()},()=>{s({code:"611018",message:"切换旁路推流布局失败",data:{}})})}setBroadCastScreen({mainScreenStreamId:e},t=(()=>{}),s=(()=>{})){this.room.setMixLayoutMainScreen(e,()=>{t()},()=>{s({code:"611018",message:"切换旁路推流主屏失败",data:{}})})}apply(e,t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId};this.requestApi(h,i).then(()=>{t()}).catch(e=>{s({code:"611024",message:"申请上麦失败",data:{}})})}consentApply({userId:e},t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,audit_user_id:e,audit_type:1};this.requestApi(o,i).then(()=>{t()}).catch(e=>{s({code:"611019",message:"同意申请上麦失败",data:{}})})}rejectApply({userId:e},t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,audit_user_id:e,audit_type:2};this.requestApi(o,i).then(()=>{t()}).catch(e=>{s({code:"611020",message:"拒绝申请上麦失败",data:{}})})}invite({userId:e},t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,askfor_third_user_id:e};this.requestApi(c,i).then(()=>{t()}).catch(e=>{s({code:"611021",message:"邀请上麦失败",data:{}})})}consentInvite(e,t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,stream_id:"",type:1};this.requestApi(l,i).then(()=>{t()}).catch(e=>{s({code:"611022",message:"同意被邀请上麦失败",data:{}})})}rejectInvite(e,t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,stream_id:"",type:3};this.requestApi(l,i).then(()=>{t()}).catch(e=>{s({code:"611023",message:"拒绝被邀请上麦失败",data:{}})})}getBlackList({},e=(()=>{}),t=(()=>{})){let s={inav_id:this.inavId};this.requestApi(u,s).then(s=>{200==s.code?e(s.data.lists):t({code:"611025",message:"获取黑名单列表失败",data:s})}).catch(e=>{t({code:"611025",message:"获取黑名单列表失败",data:e})})}addBlackList({userId:e},t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,type:1,kick_user_id:e};this.requestApi(d,i).then(()=>{t()}).catch(e=>{s({code:"611027",message:"添加用户进黑名单失败",data:{}})})}removeBlackList({userId:e},t=(()=>{}),s=(()=>{})){let i={inav_id:this.inavId,type:2,kick_user_id:e};this.requestApi(d,i).then(()=>{t()}).catch(e=>{s({code:"611028",message:"移除黑名单用户失败",data:{}})})}}class ne extends _{constructor({pusherId:e=null,THIS:t=null,room:s={}}){super(),this.pusherId=e,this.THIS=t,this.room=s}toAwait(e){return e.then(e=>[null,e]).catch(e=>[e])}destroy(){}getPusher(){return wx.createLivePusherContext(this.pusherId,this.THIS)}start(e){this.room.generalAddStream(this.room.localStream,"livePusher"),this.getPusher().start(e)}stop(e){this.getPusher().stop(e)}pause(e){this.getPusher().pause(e),this.room.generalChangeReportMsg({name:"livePusher",attr:"reportAllowed",value:!1})}resume(e){this.getPusher().resume(e),this.room.generalChangeReportMsg({name:"livePusher",attr:"reportAllowed",value:!0})}switchCamera(e){this.getPusher().switchCamera(e)}snapshot(e){this.getPusher().snapshot(e)}toggleTorch(e){this.getPusher().toggleTorch(e)}playBGM(e){this.getPusher().playBGM(e)}pauseBGM(e){this.getPusher().pauseBGM(e)}resumeBGM(e){this.getPusher().resumeBGM(e)}stopBGM(e){this.getPusher().stopBGM(e)}setBGMVolume(e){this.getPusher().setBGMVolume(e)}setMICVolume(e){this.getPusher().setMICVolume(e)}startPreview(e){this.getPusher().startPreview(e)}stopPreview(e){this.getPusher().stopPreview(e)}sendMessage(e){this.getPusher().sendMessage(e)}pusherStatechange({detail:e}){switch(e.code){case-1307:case 3001:case 3002:case 3003:case 3004:case 3005:Object.keys(this.room.reportMessage.livePusher).length&&(this.room.pusherConnectionFail(e),this.room.unpublish(),this.emit("pusherFail",e));break;case 1002:this.emit("pusherSucc")}}pusherNetstatus({detail:{info:e}}){Object.keys(this.room.reportMessage.livePusher).length&&this.room.generalChangeReportMsg({name:"livePusher",attr:"info",value:e})}pusherror(){}bgmstart(){}bgmprogress(){}bgmcomplete(){}}class oe extends _{constructor({THIS:e=null,room:t={}}){super(),this.THIS=e,this.room=t}getPlayer(e){return wx.createLivePlayerContext(e,this.THIS)}play({playerId:e,streamId:t},s){this.getPlayer(e).play(s),this.room.generalAddStream(this.room.remoteStreams[t])}pause({playerId:e,streamId:t},s){this.getPlayer(e).pause(s),this.room.generalChangeReportMsg({name:"livePlayer",key:t,attr:"reportAllowed",value:!1})}resume({playerId:e,streamId:t},s){this.getPlayer(e).resume(s),this.room.generalChangeReportMsg({name:"livePlayer",key:t,attr:"reportAllowed",value:!0})}stop({playerId:e,streamId:t},s){this.getPlayer(e).stop(s),this.room.unsubscribe({streamId:t})}requestFullScreen({playerId:e},t){this.getPlayer(e).requestFullScreen(t)}exitFullScreen({playerId:e},t){this.getPlayer(e).exitFullScreen(t)}mute({playerId:e},t){this.getPlayer(e).mute(t)}snapshot({playerId:e},t){this.getPlayer(e).snapshot(t)}playerStatechange(e){const t=e.currentTarget.dataset.streamId||"";switch(e.detail.code){case-2301:case-2302:case 2101:case 2102:case 3001:case 3002:case 3003:case 3004:case 3005:t&&this.room.reportMessage.livePlayer[t]&&(this.room.playerConnectionFail({streamId:t,code:e.detail.code}),this.emit("playerFail",{streamId:t,playerId:e.currentTarget.id}));break;case 2004:this.emit("playerSucc",{streamId:t,playerId:e.currentTarget.id})}}playerNetstatus(e){const t=e.currentTarget.dataset.streamid||"";t&&this.room.reportMessage.livePlayer[t]&&this.room.generalChangeReportMsg({name:"livePlayer",key:t,attr:"info",value:e.detail.info})}request(e){return new Promise((t,s)=>{wx.request({url:e,method:"GET",success:e=>{const i=e.data;if(200!==i.code)return console.error("call sdk api failed, code =",i.code),void s(i);t(i.data)},fail:e=>{console.error("call sdk api failed!!"),s(e)}})})}}class he{constructor(){this.socket=null,this.inavInstance=null,this.requestApi=this.requestApi.bind(this)}init(e){return this.request=new i(e).requestApi,this.socket=new g({...e,request:this.request}),new Promise((e,t)=>{this.socket.init(()=>{e()},e=>{t(e)})})}requestApi(e,t){return new Promise((s,i)=>{this.request(e,t,e=>{s(e)},e=>{i(e)})})}connectMessageService(){try{this.socket.on("Join",e=>{this.inavInstance.addUser({userId:e.third_party_user_id})}),this.socket.on("Leave",e=>{this.inavInstance.delUser({userId:e.third_party_user_id})}),this.socket.on("Inav",e=>{switch(e.data.inav_event){case"apply_inav_publish":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_APPLY,{userId:e.third_party_user_id});break;case"audit_inav_publish":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_AUTH,{userId:e.data.third_party_user_id,status:e.data.status});break;case"askfor_inav_publish":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_INVITED,{userId:e.data.third_party_user_id});break;case"kick_inav":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_BLACKLIST,{userId:e.data.third_party_user_id});break;case"user_publish_callback":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_CALLBACK,{userId:e.data.third_party_user_id,status:e.data.status});break;case"inav_close":this.inavInstance.emit(this.inavInstance.EVENT_ROOM_CLOSE,{})}}),this.socket.on("connectFail",e=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_ERROR,e)}),this.socket.on("onClose",e=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_CLOSE,e)}),this.socket.on("reConnecting",()=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_RECONNECTING)}),this.socket.on("reConnected",()=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_RECONNECTED)}),this.socket.on("reConnectFail",()=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_RECONNECTFAIL)}),this.socket.on("onError",e=>{this.inavInstance.emit(this.inavInstance.EVENT_ROOM_ERROR,e)})}catch(e){}return new Promise((e,t)=>{this.socket.connect(()=>{e()},e=>{switch(e){case"应用查询为空":t({code:"611030",message:"appId不存在",data:{}});break;default:t({code:"611000",message:"初始化房间失败",data:{}})}})})}destroy(){try{this.inavInstance&&this.inavInstance.close(),this.socket&&this.socket.close()}catch(e){console.warn(e)}}onComponent(){this.livePusher.on("pusherFail",e=>{this.inavInstance.emit(this.inavInstance.EVENT_PUSHERERROR,e)}),this.livePusher.on("pusherSucc",()=>{this.inavInstance.emit(this.inavInstance.EVENT_PUSHERSUCC)}),this.livePlayer.on("playerFail",e=>{this.inavInstance.emit(this.inavInstance.EVENT_PLAYERREEOR,e)}),this.livePlayer.on("playerSucc",e=>{this.inavInstance.emit(this.inavInstance.EVENT_PLAYERSUCC,e)})}createInstance(e,t,s=(()=>{})){const{inavId:i,appId:n,accountId:o,token:h,roomId:c,livePusherId:l=null,THIS:d=null}=e;if(new RegExp("[\\u4E00-\\u9FFF]+","g").test(o))return void s({code:"611029",message:"accountId不能为中文",data:{}});if(!(o&&i&&n&&h&&c&&l))return void s({code:"611001",message:"无效的参数",data:{}});let u={};u.roomId=c,u.appId=n,u.thirdPartyUserId=o,u.accessToken=h,u.channelId=i,this.init(u).then(()=>this.requestApi(r,{inav_id:i})).then(t=>{let s={upLogUrl:this.socket.getKV("log_server"),app_id:n,accountId:o,inavId:i,byPassUrl:t.data.pushUrl,requestApi:this.requestApi};this.inavInstance=new ae(s);let r={token:t.data.inav_token,biz_role:e.biz_role||0,biz_id:e.biz_id||0,biz_des01:e.biz_des01||0};return this.inavInstance.roomConnect(r)}).then(()=>this.connectMessageService(o)).then(()=>this.requestApi(a,{inav_id:i})).then(e=>{for(let t of e.data.lists)this.inavInstance.addUser({userId:t.third_party_user_id});this.livePusher=new ne({pusherId:l,THIS:d,room:this.inavInstance.getRoom()}),this.livePlayer=new oe({THIS:d,room:this.inavInstance.getRoom()}),this.onComponent();let s={vhallrtc:this.inavInstance,streams:this.inavInstance.streamsIds(),livePusher:this.livePusher,livePlayer:this.livePlayer};t(s)}).catch(e=>{try{this.inavInstance.close()}catch(e){}s(e)})}}}]);