module.exports=function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=1)}([,function(t,e,s){"use strict";s.r(e),s.d(e,"default",(function(){return c}));class i{constructor(){this.info={}}setKV(t,e){this.info[t]=e}getKV(t){return this.info[t]}deleteKey(t){this.info.hasOwnProperty(t)&&delete this.info[t]}reset(){this.info={}}toString(){let t=Object.keys(this.info),e="";return t.forEach(t=>{e+=`${t}:${this.info[t]} `}),e}}class n{constructor(){this.dispatcher={eventListeners:{}}}on(t,e){void 0===this.dispatcher.eventListeners[t]&&(this.dispatcher.eventListeners[t]=[]),this.dispatcher.eventListeners[t].push(e)}off(t,e=""){let s=this.dispatcher.eventListeners[t];if(s)if(e)for(let t=0;t<s.length;t++){s[t].nickName==e&&s.splice(t,1)}else s=[]}emit(t,e={}){if(!t)throw new Error("Undefined event");const s=this.dispatcher.eventListeners[t]||[];for(let t=0;t<s.length;t+=1)s[t](e)}has(t){return!!Object.keys(this.dispatcher.eventListeners).includes(t)}reset(){this.dispatcher={eventListeners:{}}}}class r extends n{constructor(t){super(),this.options=t,this.socketTask=null,this.orderNumber=0,this.socketStatus=!1,this.reconnectOut=null,this.heartInterval=null,this.reconnectTimes=0,this.customChat=t.customChat||!1,this.pingInterval=25e3,this.pingTimeout=6e4,this.packets={open:"0",close:"1",ping:"2",pong:"3",message:"4",upgrade:"5",noop:"6"},this.initSocket=this.initSocket.bind(this),this.bindOpen=this.bindOpen.bind(this),this.bindMessage=this.bindMessage.bind(this),this.bindError=this.bindError.bind(this),this.bindClose=this.bindClose.bind(this),this.incrementNumber=this.incrementNumber.bind(this),this.send=this.send.bind(this),this.sendRtc=this.sendRtc.bind(this),this.close=this.close.bind(this),this.stopTimeout=this.stopTimeout.bind(this)}initSocket(t=(()=>{}),e=(()=>{})){this.socketTask=null;const s=this;this.socketTask=wx.connectSocket({url:this.options.url,success(e){t(e)},fail(t){e(t),s.stopHeart()}}),this.bindOpen(),this.bindMessage(),this.bindClose(),this.bindError()}bindOpen(){this.socketTask.onOpen(t=>{this.socketStatus=!0,this.emit("onOpen",t),this.reconnectTimes&&(this.emit("reConnected",t),this.socketTask,this.stopTimeout()),this.customChat&&this.startHeart()})}bindMessage(){this.socketTask.onMessage(t=>{if(!isNaN(Number(t.data)))return;const e=this.foramtMsg(t.data);e.needEmit&&this.emit("onMessage",e.data)})}bindError(){this.socketTask.onError(t=>{this.emit("onError",t)})}bindClose(){this.socketTask.onClose(t=>{this.socketStatus=!1,this.stopHeart(),this.emit("onClose",t),1e3!=t.code&&1001!=t.code&&1006!=t.code&&this.incrementNumber()})}send(t,e=!0){1==this.socketTask.readyState&&(e&&(t.data=`${this.packets.message}${this.packets.ping}["${t.name}",${JSON.stringify(t.data)}]`),this.socketTask.send(t))}sendRtc({data:t,name:e},s,i){1==this.socketTask.readyState&&(t=`${this.packets.message}${this.packets.ping}${this.orderNumber}["${e}",${JSON.stringify(t)}]`,this.on(`${this.packets.message}${this.packets.pong}${this.orderNumber}`,s),this.socketTask.send({data:t,success:t=>{},fail:t=>{i(t)}}))}close(t={},e=!1){return this.stopTimeout(),this.stopHeart(),e&&this.reset(),3==this.socketTask.readyState?Promise.resolve():new Promise((e,s)=>{this.customChat&&this.socketTask.send({data:`${this.packets.message}${this.packets.close}`},!1),this.socketStatus=!1,this.socketTask.close({code:1e3,...t,success:t=>{setTimeout(()=>{e(t)},1e3)},fail:t=>{s(t)}})})}incrementNumber(){this.reconnectTimes++,this.reconnectTimes<4&&!this.socketStatus?(this.initSocket(),this.emit("reConnecting"),this.reconnectOut=setTimeout(this.incrementNumber,5e3)):(this.emit("reConnectFail"),this.stopTimeout())}foramtMsg(t){let e={needEmit:!0,data:{}};try{e.data=JSON.parse(t),e.data=decodeURIComponent(e.data.text)}catch(s){e.needEmit=!1;let i=parseInt(t);if(i<100){if(t.startsWith(`${this.packets.message}${this.packets.ping}`)){let e=t.substring(2);e=JSON.parse(e),this.emit(e[0],e[1]),this.emit("allSocket",{name:e[0],data:e[1]})}if(t.startsWith(`${this.packets.open}`)){let e=t.substring(1);e=JSON.parse(e),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout}}else{i+="";const e=i.length;let s=t.substring(e);s=JSON.parse(s),this.emit(i,s[0]),this.off(i),this.orderNumber++}}return e}startHeart(){this.heartInterval||(this.heartInterval=setInterval(()=>{this.send({data:this.packets.ping},!1)},this.pingInterval))}stopHeart(){clearInterval(this.heartInterval),this.heartInterval=null}stopTimeout(){this.reconnectTimes=0,clearTimeout(this.reconnectOut),this.reconnectOut=null}async initiativeReconnect(){return new Promise((t,e)=>{let s=()=>{t()};s.nickName="tempSucc";let i=()=>{e()};i.nickName="tempFail",this.close().then(()=>{this.off("reConnected","tempSucc"),this.off("reConnectFail","tempFail"),this.on("reConnected",s),this.on("reConnectFail",i),this.incrementNumber()}).catch(()=>{t()})})}}const o={PUSHSTREAM:"pushstream",CHAT:"chat",RTC:"rtc"};class c extends n{constructor(){super(),this.app_id=null,this.third_party_user_id=null,this.access_token=null,this.collect=null,this.channelArray=[],this.package_check="peter",this.client="wechat_applet",this.host="https://api.vhallyun.com/sdk",this.initAPI="/v2/init/start",this.sendAPI="/v2/message/send",this.inited=!1,this.store=new i,this.initCollect()}async createInstance({appId:t,accountId:e,token:s}){if("string"!=typeof t)return Promise.reject({code:201,msg:"appId must be a string"});if("string"!=typeof e)return Promise.reject({code:201,msg:"accountId must be a string"});if("string"!=typeof s)return Promise.reject({code:201,msg:"token must be a string"});this.app_id=t,this.third_party_user_id=e,this.access_token=s;try{return await this.init(),Promise.resolve()}catch(t){return Promise.reject()}}dispatch(t,e){let s;try{s="string"==typeof t?JSON.parse(t):t}catch(t){return void console.error(t)}this.has(s.event)?this.emit(s.event,{...s,socketName:e}):this.has(s.service_type)?this.emit(s.service_type,{...s,socketName:e}):this.emit("msg",{...s,socketName:e})}connect({url:t,customChat:e=!0,name:s,param:i={}}){return new Promise((n,c)=>{const a=new r({url:t,customChat:e});a.param=i,this.collect.add(s,a),a.initSocket(()=>{},t=>{c(t),this.collect.del(s),s!=o.PUSHSTREAM&&this.emit("connectFail",{...t,socketName:s})}),a.on("onMessage",t=>{this.dispatch(t,s)}),a.on("msg",t=>{this.dispatch(t,s)}),a.on("onOpen",t=>{n(),s!=o.PUSHSTREAM&&this.emit("onOpen",{...t,socketName:s})}),a.on("onClose",t=>{s!=o.PUSHSTREAM&&this.emit("onClose",{...t,socketName:s})}),a.on("onError",t=>{s!=o.PUSHSTREAM&&this.emit("onTaskError",{...t,socketName:s})}),a.on("reConnecting",()=>{s!=o.PUSHSTREAM&&this.emit("reConnecting",{socketName:s})}),a.on("reConnected",()=>{s!=o.PUSHSTREAM&&this.emit("reConnected",{socketName:s})}),a.on("reConnectFail",()=>{s!=o.PUSHSTREAM&&this.emit("reConnectFail",{socketName:s})}),a.on("allSocket",t=>{this.emit("allSocket",{...t,socketName:s})}),a.on("joined",t=>{this.emit("joined",{...t,socketName:s})})})}initCollect(){this.collect={socket:{},add(t,e){this.socket[t]=e},del(t){this.socket[t]&&this.socket[t].close({},!0),delete this.socket[t]},has(t){return!!this.socket[t]},get(t){return!!this.socket[t]&&this.socket[t]}}}async addChannel(t){let e=[];if(this.collect.has(o.PUSHSTREAM)){if(e=this.collect.get(o.PUSHSTREAM).param.channelArray,e.includes(t))return Promise.resolve();try{await this.close(o.PUSHSTREAM)}catch(t){console.warn(t)}}e.push(t),this.connectPushStream({channelArray:e})}async removeChannel(t){let e;if(this.collect.has(o.PUSHSTREAM)&&(e=this.collect.get(o.PUSHSTREAM).param.channelArray,e.includes(t))){!function(t,e){Array.isArray(t)&&t.splice(t.findIndex(t=>t==e),1)}(e);try{await this.close(o.PUSHSTREAM)}catch(t){console.warn(t)}e.length&&this.connectPushStream({channelArray:e})}}async connectPushStream({channelArray:t=[]}){let e="";for(const s of t)e+=`/${s}`;const s=`${this.store.getKV("nginx_server").replace(/http/,"ws")}/ws${e}/?_=${(new Date).getTime()}&tag=0&time=&eventid=`;try{return await this.connect({url:s,customChat:!1,name:o.PUSHSTREAM,param:{channelArray:t}}),Promise.resolve()}catch(t){return console.warn(t),Promise.reject()}}async connectSocketIo({name:t="chat"}){if(this.collect.has(o.CHAT))return Promise.resolve();const e=`${this.store.getKV("socket_server").replace(/http/,"ws")}/socket.io/?token=${this.store.getKV("connection_token")}&EIO=3&transport=websocket`;try{return await this.connect({url:e,name:t}),Promise.resolve()}catch(t){return console.warn(t),Promise.reject()}}async connectRtcIo({name:t="rtc",host:e}){if(this.collect.has(o.RTC))return Promise.resolve();const s=`wss://${e.split(":443")[0]}/socket.io/?EIO=3&transport=websocket`;try{return await this.connect({url:s,name:t}),Promise.resolve()}catch(t){return console.warn(t),Promise.reject()}}async close(t){if(!t){const t=Object.keys(this.collect.socket);for(const e of t)this.collect.del(e);return Promise.resolve()}if(!this.collect.has(t))return Promise.resolve();const e=this.collect.get(t);try{await e.close({},!0)}catch(t){console.warn(t)}return this.collect.del(t),Promise.resolve()}join(t,{third_party_user_id:e,context:s={},hide:i=!1,channelId:n}){if(!this.collect.has(t))return;const r=this.collect.get(t),o={channel:n,third_party_user_id:e,context:JSON.stringify(s),hide:i};r.send({data:o,name:"join"})}leave(t,{third_party_user_id:e,channelId:s}){if(!this.collect.has(t))return;const i=this.collect.get(t),n={channel:i.param.channelId,third_party_user_id:e};i.send({data:n,name:"leave"}),this.close()}init(t={}){if(!this.inited)return new Promise((e,s)=>{this.request(this.initAPI,t,t=>{try{for(let e in t.data)this.store.setKV(e,t.data[e]);e(),this.inited=!0}catch(t){s(t),this.inited=!1}},t=>{s(t)})})}request(t,e,s=(()=>{}),i=(()=>{})){e.client=this.client,e.app_id=this.app_id,e.third_party_user_id=this.third_party_user_id,e.access_token=this.access_token,e.package_check=this.package_check,wx.request({url:`${this.host}${t}`,data:e,method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},success:t=>{t.statusCode>=400?i({code:400,message:"调用接口失败"}):200!==t.data.code?i(t.data):s(t.data)},fail:i})}sendHttpMsg(t,e,s={},i=0){return new Promise((n,r)=>{let o={type:t,channel_id:e.channelId,no_audit:i,body:"string"==typeof e?e:JSON.stringify(e),context:JSON.stringify(s)};this.request(this.sendAPI,o,t=>{n(t)},t=>{r(t)})})}sendMessage(t,e){if(!this.collect.has(o.RTC))return;const s=this.collect.get(o.RTC);return new Promise((i,n)=>{s.sendRtc({name:t,data:e},t=>{"success"==t.result?i(t):n(t)},t=>{n(t)})})}initiativeReconnect(){let t=[];for(const e in this.collect.socket)if(this.collect.socket.hasOwnProperty(e)){const s=this.collect.socket[e];t.push(s.initiativeReconnect())}return Promise.all(t)}get socketName(){return o}get version(){return"1.0.0"}}}]);